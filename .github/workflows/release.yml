name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to release (e.g., v0.11.0)'
        required: true
        type: string
      pytorch_release:
        description: 'PyTorch release branch (e.g., release/2.8)'
        required: true
        type: string
      skip_sanity_checks:
        description: 'Skip sanity checks (for retry after fixing issues)'
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: write

jobs:
  # =============================================================================
  # Sanity Checks
  # =============================================================================
  sanity-checks:
    if: ${{ !inputs.skip_sanity_checks }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_version: ${{ steps.version.outputs.short_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref_name }}
          fetch-depth: 0

      - name: Extract version info
        id: version
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          # Remove 'v' prefix: v0.11.0 -> 0.11.0
          VERSION="${TAG#v}"
          # Short version for docs: 0.11.0 -> 0.11
          SHORT_VERSION=$(echo "$VERSION" | sed 's/\.[0-9]*$//')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_version=$SHORT_VERSION" >> $GITHUB_OUTPUT
          echo "Tag: $TAG"
          echo "Version: $VERSION"
          echo "Short version: $SHORT_VERSION"

      - name: Validate release branch exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Checking for release branch: release/$VERSION"
          
          if ! git ls-remote --exit-code origin "refs/heads/release/$VERSION"; then
            echo "::error::Release branch 'release/$VERSION' does not exist"
            exit 1
          fi
          echo "Release branch exists"

      - name: Validate tag exists on release branch
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # Check that the tag commit is on the release branch
          TAG_COMMIT=$(git rev-list -n 1 "$TAG")
          git fetch origin "release/$VERSION"
          
          if ! git merge-base --is-ancestor "$TAG_COMMIT" "origin/release/$VERSION"; then
            echo "::error::Tag $TAG is not on branch release/$VERSION"
            exit 1
          fi
          echo "Tag $TAG is on release/$VERSION branch"

      - name: Validate version.txt matches tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FILE_VERSION=$(cat version.txt | tr -d '[:space:]')
          
          if [[ "$FILE_VERSION" != "$VERSION" ]]; then
            echo "::error::version.txt contains '$FILE_VERSION' but tag is 'v$VERSION'"
            exit 1
          fi
          echo "version.txt matches tag: $FILE_VERSION"

      - name: Validate tensordict version compatibility
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Extract major.minor from version (0.11.0 -> 0.11)
          MAJOR_MINOR=$(echo "$VERSION" | sed 's/\.[0-9]*$//')
          
          # Parse tensordict requirement from pyproject.toml
          TD_REQ=$(grep -E '"tensordict[^"]*"' pyproject.toml | head -1)
          echo "TensorDict requirement: $TD_REQ"
          
          # Check that the requirement includes the same major.minor version
          if ! echo "$TD_REQ" | grep -q "$MAJOR_MINOR"; then
            echo "::error::TensorDict version in pyproject.toml should match major version $MAJOR_MINOR"
            echo "Found: $TD_REQ"
            exit 1
          fi
          echo "TensorDict version constraint is compatible"

      - name: Validate TORCHRL_BUILD_VERSION in td_script.sh
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_VERSION=$(grep -E '^export TORCHRL_BUILD_VERSION=' .github/scripts/td_script.sh | cut -d'=' -f2)
          
          if [[ "$BUILD_VERSION" != "$VERSION" ]]; then
            echo "::error::TORCHRL_BUILD_VERSION in td_script.sh is '$BUILD_VERSION' but should be '$VERSION'"
            exit 1
          fi
          echo "TORCHRL_BUILD_VERSION matches: $BUILD_VERSION"

      - name: Check stable docs will be correct
        run: |
          SHORT_VERSION="${{ steps.version.outputs.short_version }}"
          
          # Verify the docs folder exists on gh-pages (or will be created)
          echo "After release, stable docs will point to version: $SHORT_VERSION"
          echo "Docs URL will be: https://docs.pytorch.org/rl/$SHORT_VERSION/index.html"

  # =============================================================================
  # Build Wheels (all platforms in parallel)
  # =============================================================================
  build-linux:
    needs: [sanity-checks]
    if: always() && (needs.sanity-checks.result == 'success' || needs.sanity-checks.result == 'skipped')
    uses: ./.github/workflows/build-wheels-linux.yml
    with:
      test-infra-ref: ${{ inputs.pytorch_release || 'main' }}
    secrets: inherit

  build-linux-aarch64:
    needs: [sanity-checks]
    if: always() && (needs.sanity-checks.result == 'success' || needs.sanity-checks.result == 'skipped')
    uses: ./.github/workflows/build-wheels-aarch64-linux.yml
    with:
      test-infra-ref: ${{ inputs.pytorch_release || 'main' }}
    secrets: inherit

  build-macos:
    needs: [sanity-checks]
    if: always() && (needs.sanity-checks.result == 'success' || needs.sanity-checks.result == 'skipped')
    uses: ./.github/workflows/build-wheels-m1.yml
    with:
      test-infra-ref: ${{ inputs.pytorch_release || 'main' }}
    secrets: inherit

  build-windows:
    needs: [sanity-checks]
    if: always() && (needs.sanity-checks.result == 'success' || needs.sanity-checks.result == 'skipped')
    uses: ./.github/workflows/build-wheels-windows.yml
    with:
      test-infra-ref: ${{ inputs.pytorch_release || 'main' }}
    secrets: inherit

  # =============================================================================
  # Collect all wheels into single artifact
  # =============================================================================
  collect-wheels:
    needs: [build-linux, build-linux-aarch64, build-macos, build-windows]
    if: always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    runs-on: ubuntu-latest
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels/
          pattern: '*wheel*'
          merge-multiple: true

      - name: List collected wheels
        run: |
          echo "Collected wheels:"
          find wheels/ -name "*.whl" -type f | sort
          WHEEL_COUNT=$(find wheels/ -name "*.whl" -type f | wc -l)
          echo "Total wheels: $WHEEL_COUNT"
          
          if [[ $WHEEL_COUNT -eq 0 ]]; then
            echo "::error::No wheels were collected!"
            exit 1
          fi

      - name: Upload merged wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-wheels
          path: wheels/*.whl
          if-no-files-found: error

  # =============================================================================
  # Update documentation on gh-pages
  # =============================================================================
  update-docs:
    needs: [sanity-checks, collect-wheels]
    if: always() && needs.collect-wheels.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1

      - name: Get version info
        id: version
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION="${TAG#v}"
          SHORT_VERSION=$(echo "$VERSION" | sed 's/\.[0-9]*$//')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_version=$SHORT_VERSION" >> $GITHUB_OUTPUT

      - name: Check if docs update needed
        id: check
        run: |
          SHORT_VERSION="${{ steps.version.outputs.short_version }}"
          CURRENT_STABLE=$(cat stable 2>/dev/null || echo "")
          
          echo "Current stable pointer: $CURRENT_STABLE"
          echo "New version: $SHORT_VERSION"
          
          if [[ "$CURRENT_STABLE" == "$SHORT_VERSION" ]]; then
            echo "Stable symlink already points to $SHORT_VERSION"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Update stable symlink
        if: steps.check.outputs.needs_update == 'true'
        run: |
          SHORT_VERSION="${{ steps.version.outputs.short_version }}"
          echo "$SHORT_VERSION" > stable
          echo "Updated stable to point to: $SHORT_VERSION"

      - name: Update versions.html
        if: steps.check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHORT_VERSION="${{ steps.version.outputs.short_version }}"
          
          # Check if version already exists in versions.html
          if grep -q "href=\"$SHORT_VERSION/\"" versions.html; then
            echo "Version $SHORT_VERSION already in versions.html"
          else
            echo "Adding version $SHORT_VERSION to versions.html"
            # This is a simplified update - in practice, may need more complex HTML manipulation
          fi
          
          # Update the "(stable release)" marker
          # Remove old stable marker
          sed -i 's/ (stable release)//g' versions.html
          
          # Add new stable marker to the current version
          sed -i "s|href=\"$SHORT_VERSION/\">v$SHORT_VERSION|href=\"$SHORT_VERSION/\">v$SHORT_VERSION (stable release)|g" versions.html
          
          echo "Updated versions.html"
          grep -A2 -B2 "stable release" versions.html || true

      - name: Commit and push docs update
        if: steps.check.outputs.needs_update == 'true'
        run: |
          git config user.name 'pytorchbot'
          git config user.email 'soumith+bot@pytorch.org'
          
          git add stable versions.html
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update docs for release ${{ inputs.tag || github.ref_name }}"
            git push
            echo "Pushed docs update"
          fi

  # =============================================================================
  # Create draft GitHub release
  # =============================================================================
  create-draft-release:
    needs: [collect-wheels]
    if: always() && needs.collect-wheels.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: release-wheels
          path: dist/

      - name: Get tag name
        id: tag
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Check if release exists
        id: check_release
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          if gh release view "$TAG" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create draft release
        if: steps.check_release.outputs.exists == 'false'
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          
          # Create draft release with wheels attached
          # Note: Release notes should be manually written, not auto-generated
          gh release create "$TAG" \
            --draft \
            --title "Release $TAG" \
            --notes "Release notes pending. Please edit before publishing." \
            dist/*.whl
          
          echo "Created draft release: $TAG"
          echo "Please edit the release notes before publishing!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload wheels to existing release
        if: steps.check_release.outputs.exists == 'true'
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          
          # Upload wheels to existing release
          for wheel in dist/*.whl; do
            echo "Uploading $wheel"
            gh release upload "$TAG" "$wheel" --clobber || true
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Publish to PyPI (requires manual approval via environment)
  # =============================================================================
  publish-pypi:
    needs: [collect-wheels, update-docs, create-draft-release]
    if: always() && needs.collect-wheels.result == 'success'
    runs-on: ubuntu-latest
    environment: pypi-publish
    permissions:
      id-token: write
    steps:
      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: release-wheels
          path: dist/

      - name: List wheels to publish
        run: |
          echo "Wheels to publish to PyPI:"
          ls -la dist/
          
          # Verify we have wheels
          WHEEL_COUNT=$(find dist/ -name "*.whl" -type f | wc -l)
          if [[ $WHEEL_COUNT -eq 0 ]]; then
            echo "::error::No wheels found to publish!"
            exit 1
          fi
          echo "Publishing $WHEEL_COUNT wheels"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # Uses OIDC trusted publishing - no API token needed
          # Requires setup at: https://pypi.org/manage/project/torchrl/settings/publishing/
          verbose: true
