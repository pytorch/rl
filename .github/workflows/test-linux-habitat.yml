# NOTE: Habitat tests are temporarily disabled.
# 
# Reason: tensordict now requires Python >= 3.10, but habitat-sim conda packages
# only support Python < 3.10. Building habitat-sim from source is problematic:
# - CMake 4.x compatibility issues with old CMake files
# - Dataset downloads via git-lfs are extremely slow (prune operations take hours)
# 
# Re-enable this workflow when habitat-sim officially supports Python 3.10+ via conda.
# Track progress at: https://github.com/facebookresearch/habitat-sim/issues/2289

name: Habitat Tests on Linux

on:
  # Disabled - only run manually
  workflow_dispatch:
  # Commented out triggers:
  # pull_request:
  # push:
  #   branches:
  #     - nightly
  #     - main
  #     - release/*

concurrency:
  group: ${{ github.workflow }}-${{ github.ref == 'refs/heads/main' && format('ci-master-{0}', github.sha) || format('ci-{0}', github.ref) }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  tests:
    # Skip for now - habitat-sim doesn't support Python 3.10+ via conda
    if: false
    strategy:
      matrix:
        python_version: ["3.10"]
        cuda_arch_version: ["12.8"]
      fail-fast: false
    uses: pytorch/test-infra/.github/workflows/linux_job_v2.yml@main
    with:
      runner: linux.g5.4xlarge.nvidia.gpu
      repository: pytorch/rl
      docker-image: "nvidia/cuda:12.1.1-devel-ubuntu22.04"
      gpu-arch-type: cuda
      gpu-arch-version: ${{ matrix.cuda_arch_version }}
      timeout: 90
      script: |
        if [[ "${{ github.ref }}" =~ release/* ]]; then
          export RELEASE=1
          export TORCH_VERSION=stable
        else
          export RELEASE=0
          export TORCH_VERSION=nightly
        fi

        # Set env vars from matrix
        export PYTHON_VERSION=${{ matrix.python_version }}
        export CUDA_ARCH_VERSION=${{ matrix.cuda_arch_version }}
        export CU_VERSION="cu${CUDA_ARCH_VERSION:0:2}${CUDA_ARCH_VERSION:3:1}"
        export TD_GET_DEFAULTS_TO_NONE=1

        bash .github/unittest/linux_libs/scripts_habitat/run_all.sh
