


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torchrl.envs.llm.transforms.tools &mdash; torchrl main documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/sg_gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/sg_gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/sg_gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/sphinx-design.5ea377869091fd0449014c60fc090103.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','UA-117752657-2');</script>
    <!-- End Google Tag Manager -->
  

  
  <script src="../../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Learn
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/get-started">
                  <span class=dropdown-title>Get Started</span>
                  <p>Run PyTorch locally or get started quickly with one of the supported cloud platforms</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials">
                  <span class="dropdown-title">Tutorials</span>
                  <p>Whats new in PyTorch tutorials</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/basics/intro.html">
                  <span class="dropdown-title">Learn the Basics</span>
                  <p>Familiarize yourself with PyTorch concepts and modules</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/recipes/recipes_index.html">
                  <span class="dropdown-title">PyTorch Recipes</span>
                  <p>Bite-size, ready-to-deploy PyTorch code examples</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/introyt.html">
                  <span class="dropdown-title">Intro to PyTorch - YouTube Series</span>
                  <p>Master PyTorch basics with our engaging YouTube tutorial series</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Ecosystem
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem">
                  <span class="dropdown-title">Tools</span>
                  <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class=dropdown-title>Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class=dropdown-title>Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem/contributor-awards-2024">
                  <span class="dropdown-title">Contributor Awards - 2024</span>
                  <p>Award winners announced at this year's PyTorch Conference</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/edge">
                  <span class="dropdown-title">About PyTorch Edge</span>
                  <p>Build innovative and privacy-aware AI experiences for edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/executorch-overview">
                  <span class="dropdown-title">ExecuTorch</span>
                  <p>End-to-end solution for enabling on-device inference capabilities across mobile and edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/executorch/stable/index.html">
                  <span class="dropdown-title">ExecuTorch Docs</span>
                </a>
              </div>
            </div>  
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p>Explore the documentation for comprehensive guidance on how to use PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/pytorch-domains">
                  <span class="dropdown-title">PyTorch Domains</span>
                  <p>Read the PyTorch Domains documentation to learn more about domain-specific libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Blogs & News 
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/blog/">
                  <span class="dropdown-title">PyTorch Blog</span>
                  <p>Catch up on the latest technical news and happenings</p>
                </a>
                 <a class="nav-dropdown-item" href="https://pytorch.org/community-blog">
                  <span class="dropdown-title">Community Blog</span>
                  <p>Stories from the PyTorch ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/videos">
                  <span class="dropdown-title">Videos</span>
                  <p>Learn about the latest PyTorch tutorials, new, and more </p>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/newsletter">
                  <span class="dropdown-title">Newsletter</span>
                  <p>Stay up-to-date with the latest updates</p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                About
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn more about the PyTorch Foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/governing-board">
                  <span class="dropdown-title">Governing Board</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/credits">
                  <span class="dropdown-title">Cloud Credit Program</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tac">
                  <span class="dropdown-title">Technical Advisory Council</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/staff">
                  <span class="dropdown-title">Staff</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/contact-us">
                  <span class="dropdown-title">Contact Us</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="https://pytorch.org/join" data-cta="join">
                Become a Member
              </a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later. 
          <li>
            <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href="../../../../../../versions.html"><span style="font-size:110%">main (0.10.0+g9d34dbe) &#x25BC</span></a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/getting-started-0.html">Get started with Environments, TED and transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/getting-started-1.html">Get started with TorchRLâ€™s modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/getting-started-2.html">Getting started with model optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/getting-started-3.html">Get started with data collection and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/getting-started-4.html">Get started with logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/getting-started-5.html">Get started with your own first training loop</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/coding_ppo.html">Reinforcement Learning (PPO) with TorchRL Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/pendulum.html">Pendulum: Writing your environment and transforms with TorchRL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/torchrl_demo.html">Introduction to TorchRL</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/multiagent_ppo.html">Multi-Agent Reinforcement Learning (PPO) with TorchRL Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/torchrl_envs.html">TorchRL envs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/pretrained_models.html">Using pretrained models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/dqn_with_rnn.html">Recurrent DQN: Training recurrent policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/rb_tutorial.html">Using Replay Buffers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/export.html">Exporting TorchRL modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/llm_browser.html">TorchRL LLM: Building Tool-Enabled Environments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/multiagent_competitive_ddpg.html">Competitive Multi-Agent Reinforcement Learning (DDPG) with TorchRL Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/multi_task.html">Task-specific policy in multi-task environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/coding_ddpg.html">TorchRL objectives: Coding a DDPG loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/coding_dqn.html">TorchRL trainer: A DQN example</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/index.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/knowledge_base.html">Knowledge Base</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../../../index.html">Module code</a> &gt;</li>
        
      <li>torchrl.envs.llm.transforms.tools</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
    
    
          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=UA-117752657-2"
          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torchrl.envs.llm.transforms.tools</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Meta Platforms, Inc. and affiliates.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the MIT license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">TextIO</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tensordict</span><span class="w"> </span><span class="kn">import</span> <span class="n">lazy_stack</span><span class="p">,</span> <span class="n">TensorDictBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl._utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">torchrl_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.data.llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">History</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.envs</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transform</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>


<span class="c1"># --- Base Class for Tool Transforms ---</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ToolTransformBase</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for tool transforms that parse and execute tools from LLM output.</span>

<span class="sd">    This class handles all the common boilerplate for tool transforms:</span>
<span class="sd">    - History extraction and validation</span>
<span class="sd">    - Batch dimension flattening</span>
<span class="sd">    - Result collection and padding</span>
<span class="sd">    - History extension with tool results</span>

<span class="sd">    Subclasses only need to implement:</span>
<span class="sd">    - :meth:`_process_batch_item`: Extract and execute tools from one response</span>
<span class="sd">    - :meth:`_format_result`: Format one tool result as string (optional)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        use_step (bool): Whether to use _step() vs _call(). Defaults to True.</span>
<span class="sd">        tool_role (str): Role name for results in history. Defaults to &quot;tool&quot;.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; class SimpleCalculator(ToolTransformBase):</span>
<span class="sd">        ...     tool_role = &quot;calculator&quot;</span>
<span class="sd">        ...</span>
<span class="sd">        ...     def _process_batch_item(self, content: str, index: int):</span>
<span class="sd">        ...         # Extract math expressions and evaluate</span>
<span class="sd">        ...         if &quot;2+2&quot; in content:</span>
<span class="sd">        ...             return [&quot;2+2=4&quot;]</span>
<span class="sd">        ...         return None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_step</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Use _step() vs _call()</span>
    <span class="n">tool_role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tool&quot;</span>  <span class="c1"># Role name for results in history</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_and_extract_history</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">next_tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">History</span><span class="p">,</span> <span class="n">History</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate environment and extract history.</span>

<span class="sd">        Args:</span>
<span class="sd">            next_tensordict: The tensordict containing history.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (full_history, local_history) where local_history is the last message.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If parent env doesn&#39;t exist or isn&#39;t in history mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check that base_env is in history mode</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must be used with a ChatEnv&quot;</span><span class="p">)</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">base_env</span>
        <span class="k">if</span> <span class="n">base_env</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">!=</span> <span class="s2">&quot;history&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must be used with a ChatEnv in history mode&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get history and isolate last element (the LLM&#39;s response)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">next_tensordict</span><span class="p">[</span><span class="s2">&quot;history&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">prompt</span>
        <span class="n">local_history</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">history</span><span class="p">,</span> <span class="n">local_history</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process one item in the batch to extract and execute tools.</span>

<span class="sd">        This is the main method subclasses must implement.</span>

<span class="sd">        Args:</span>
<span class="sd">            content: The text content from the LLM response.</span>
<span class="sd">            index: The index of this item in the batch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str] or None: List of result strings for each tool executed,</span>
<span class="sd">                or None if no tools were found/executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must implement _process_batch_item()&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format a single result string.</span>

<span class="sd">        Override this to customize result formatting. Default is identity.</span>

<span class="sd">        Args:</span>
<span class="sd">            result: Raw result string from tool execution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Formatted result string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_inject_results_to_history</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">history</span><span class="p">:</span> <span class="n">History</span><span class="p">,</span>
        <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">next_tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDictBase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inject tool results back into history with proper batching.</span>

<span class="sd">        Args:</span>
<span class="sd">            history: The full conversation history.</span>
<span class="sd">            results: List of results per batch item (can contain None).</span>
<span class="sd">            next_tensordict: The tensordict to update.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TensorDictBase: Updated tensordict with results in history.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert string results to History objects</span>
        <span class="n">procs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch_results</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch_results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formatted_results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_result</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span>
                <span class="n">procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">History</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_role</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">formatted_results</span>
                    <span class="p">]</span>
                <span class="p">)</span>

        <span class="c1"># If there are no tool responses, skip</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">next_tensordict</span>

        <span class="c1"># Fill None entries with empty lists for consistent batching</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">):</span>
            <span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">]</span>

        <span class="c1"># Pad all results to same length (required for batching)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">procs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">procs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">):</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">fill_procs</span><span class="p">(</span><span class="n">proc</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">History</span><span class="p">],</span> <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">History</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_len</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">proc</span>
                <span class="k">return</span> <span class="n">proc</span> <span class="o">+</span> <span class="p">[</span><span class="n">History</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;&lt;none&gt;&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">)</span>
            <span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fill_procs</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">]</span>

        <span class="c1"># Stack and extend history</span>
        <span class="n">procs</span> <span class="o">=</span> <span class="n">lazy_stack</span><span class="p">([</span><span class="n">lazy_stack</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">])</span>
        <span class="n">history</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">procs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_tensordict</span><span class="p">[</span><span class="s2">&quot;history&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">history</span>

        <span class="k">return</span> <span class="n">next_tensordict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_tensordict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDictBase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main processing logic for tool transforms.</span>

<span class="sd">        Handles batch flattening, history extraction, tool processing, and result injection.</span>

<span class="sd">        Args:</span>
<span class="sd">            next_tensordict: The tensordict to process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TensorDictBase: Updated tensordict with tool results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Flatten batch dimensions if needed</span>
        <span class="k">if</span> <span class="n">next_tensordict</span><span class="o">.</span><span class="n">batch_dims</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">next_tensordict</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">next_tensordict_flat</span><span class="p">:</span>
                <span class="n">next_tensordict_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_tensordict</span><span class="p">(</span><span class="n">next_tensordict_flat</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">next_tensordict</span>

        <span class="c1"># Extract and validate history</span>
        <span class="n">history</span><span class="p">,</span> <span class="n">local_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_extract_history</span><span class="p">(</span><span class="n">next_tensordict</span><span class="p">)</span>

        <span class="c1"># Handle content as string or list</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">local_history</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">content</span><span class="p">]</span>

        <span class="c1"># Process each batch item</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
            <span class="n">batch_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_batch_item</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span>

        <span class="c1"># Inject results back into history</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inject_results_to_history</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">next_tensordict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span><span class="p">,</span> <span class="n">next_tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDictBase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle step with tool processing.</span>

<span class="sd">        Args:</span>
<span class="sd">            tensordict: Input tensordict.</span>
<span class="sd">            next_tensordict: Output tensordict.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TensorDictBase: Updated next_tensordict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_step</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> uses _call(), not _step(). Set use_step=False.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_tensordict</span><span class="p">(</span><span class="n">next_tensordict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDictBase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle call with tool processing.</span>

<span class="sd">        Args:</span>
<span class="sd">            next_tensordict: The tensordict to process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TensorDictBase: Updated tensordict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_step</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> uses _step(), not _call(). Set use_step=True.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_tensordict</span><span class="p">(</span><span class="n">next_tensordict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span><span class="p">,</span> <span class="n">tensordict_reset</span><span class="p">:</span> <span class="n">TensorDictBase</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDictBase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle reset (no-op for base class).</span>

<span class="sd">        Args:</span>
<span class="sd">            tensordict (TensorDictBase): Input tensordict.</span>
<span class="sd">            tensordict_reset (TensorDictBase): Reset tensordict.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TensorDictBase: Unchanged reset tensordict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">tensordict_reset</span>


<span class="c1"># --- Tool Service Library: Pluggable Services &amp; Parsers ---</span>


<div class="viewcode-block" id="ToolService"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.ToolService.html#torchrl.envs.llm.transforms.ToolService">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ToolService</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol for side-effecting service callable with structured IO.</span>

<span class="sd">    A tool service is a callable that can be invoked with keyword arguments</span>
<span class="sd">    and returns a dictionary of results. It has a name and input/output schemas.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The name of the tool service.</span>
<span class="sd">        schema_in (dict[str, Any]): Input schema describing expected parameters.</span>
<span class="sd">        schema_out (dict[str, Any]): Output schema describing returned data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">schema_in</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">schema_out</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the tool service.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Keyword arguments matching the input schema.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: Results matching the output schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span></div>


<div class="viewcode-block" id="ToolRegistry"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.ToolRegistry.html#torchrl.envs.llm.transforms.ToolRegistry">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ToolRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registry for managing available tool services.</span>

<span class="sd">    This class maintains a collection of tool services that can be looked up</span>
<span class="sd">    by name for execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        services (Sequence[ToolService], optional): Initial services to register.</span>
<span class="sd">            Defaults to an empty sequence.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; class AddService:</span>
<span class="sd">        ...     name = &quot;add&quot;</span>
<span class="sd">        ...     schema_in = {&quot;a&quot;: int, &quot;b&quot;: int}</span>
<span class="sd">        ...     schema_out = {&quot;result&quot;: int}</span>
<span class="sd">        ...     def __call__(self, a, b, **kwargs):</span>
<span class="sd">        ...         return {&quot;result&quot;: a + b}</span>
<span class="sd">        &gt;&gt;&gt; registry = ToolRegistry([AddService()])</span>
<span class="sd">        &gt;&gt;&gt; service = registry.get(&quot;add&quot;)</span>
<span class="sd">        &gt;&gt;&gt; result = service(a=1, b=2)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        {&quot;result&quot;: 3}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">services</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ToolService</span><span class="p">]</span> <span class="o">=</span> <span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ToolService</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">services</span><span class="p">}</span>

<div class="viewcode-block" id="ToolRegistry.register"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.ToolRegistry.html#torchrl.envs.llm.transforms.ToolRegistry.register">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">ToolService</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a new service.</span>

<span class="sd">        Args:</span>
<span class="sd">            service (ToolService): The service to register.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="p">[</span><span class="n">service</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span></div>

<div class="viewcode-block" id="ToolRegistry.get"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.ToolRegistry.html#torchrl.envs.llm.transforms.ToolRegistry.get">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolService</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a service by name.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name of the service to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ToolService: The requested service.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If the service is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tool: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a service is registered.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the service exists, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svc</span></div>


<div class="viewcode-block" id="ToolCall"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.ToolCall.html#torchrl.envs.llm.transforms.ToolCall">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ToolCall</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of a parsed tool call from LLM output.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        tool (str): The name of the tool to call.</span>
<span class="sd">        args (dict[str, Any]): Arguments to pass to the tool.</span>
<span class="sd">        tag (str | None): Optional user-visible label or correlation ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tool</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>


<span class="k">class</span><span class="w"> </span><span class="nc">ParseResult</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of parsing an LLM response for tool calls.</span>

<span class="sd">    This is a TypedDict-style class that contains:</span>
<span class="sd">        text (str): The final message to user (post tool blocks removal).</span>
<span class="sd">        calls (list[ToolCall]): Ordered tool calls as they appear.</span>
<span class="sd">        meta (dict[str, Any]): Optional parser metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">calls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span>
    <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LLMToolParser</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol for parsing LLM responses into ordered tool calls.</span>

<span class="sd">    A tool parser takes the LLM&#39;s response (as string or structured data)</span>
<span class="sd">    and extracts ordered tool calls, along with the cleaned user-facing text.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ParseResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse an LLM response.</span>

<span class="sd">        Args:</span>
<span class="sd">            response (str | dict[str, Any]): The LLM&#39;s response to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ParseResult: Parsed result with text, calls, and metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>


<div class="viewcode-block" id="XMLBlockParser"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.XMLBlockParser.html#torchrl.envs.llm.transforms.XMLBlockParser">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">XMLBlockParser</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Parser for XML-style tool blocks in LLM responses.</span>

<span class="sd">    Parses tool calls in the format:</span>
<span class="sd">        &lt;tool name=&quot;tool_name&quot; tag=&quot;optional_tag&quot;&gt;{&quot;arg&quot;: &quot;value&quot;}&lt;/tool&gt;</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; parser = XMLBlockParser()</span>
<span class="sd">        &gt;&gt;&gt; response = &#39;&lt;tool name=&quot;search&quot; tag=&quot;A&quot;&gt;{&quot;query&quot;: &quot;torchrl&quot;}&lt;/tool&gt;\\nSome text.&#39;</span>
<span class="sd">        &gt;&gt;&gt; result = parser(response)</span>
<span class="sd">        &gt;&gt;&gt; print(result[&quot;text&quot;])</span>
<span class="sd">        Some text.</span>
<span class="sd">        &gt;&gt;&gt; print(result[&quot;calls&quot;][0].tool)</span>
<span class="sd">        search</span>
<span class="sd">        &gt;&gt;&gt; print(result[&quot;calls&quot;][0].args)</span>
<span class="sd">        {&quot;query&quot;: &quot;torchrl&quot;}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;&lt;tool\s+name=&quot;(?P&lt;name&gt;[^&quot;]+)&quot;(?:\s+tag=&quot;(?P&lt;tag&gt;[^&quot;]+)&quot;)?\s*&gt;\s*(?P&lt;body&gt;.*?)\s*&lt;/tool&gt;&#39;</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ParseResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse XML-style tool blocks from response.</span>

<span class="sd">        Args:</span>
<span class="sd">            response (str | dict[str, Any]): The response to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ParseResult: Parsed result with cleaned text and tool calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">response</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">calls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">repl</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">Match</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="k">if</span> <span class="n">body</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="c1"># If JSON parsing fails, pass the raw body as a &quot;raw&quot; argument</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">body</span><span class="p">}</span>
            <span class="n">calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ToolCall</span><span class="p">(</span><span class="n">tool</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">))</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Remove block from final user-visible message</span>

        <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">repl</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ParseResult</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleaned</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;calls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calls</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="JSONCallParser"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.JSONCallParser.html#torchrl.envs.llm.transforms.JSONCallParser">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">JSONCallParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parser for JSON-style function-calling responses.</span>

<span class="sd">    Expects responses in the format:</span>
<span class="sd">        {</span>
<span class="sd">          &quot;message&quot;: &quot;...&quot;,</span>
<span class="sd">          &quot;tools&quot;: [</span>
<span class="sd">            {&quot;tool&quot;: &quot;search&quot;, &quot;args&quot;: {&quot;query&quot;: &quot;...&quot;}, &quot;tag&quot;: &quot;A&quot;},</span>
<span class="sd">            {&quot;tool&quot;: &quot;summarize&quot;, &quot;args&quot;: {&quot;text&quot;: &quot;...&quot;}}</span>
<span class="sd">          ]</span>
<span class="sd">        }</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; parser = JSONCallParser()</span>
<span class="sd">        &gt;&gt;&gt; response = {</span>
<span class="sd">        ...     &quot;message&quot;: &quot;Let me search for that.&quot;,</span>
<span class="sd">        ...     &quot;tools&quot;: [{&quot;tool&quot;: &quot;search&quot;, &quot;args&quot;: {&quot;query&quot;: &quot;torchrl&quot;}}]</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; result = parser(response)</span>
<span class="sd">        &gt;&gt;&gt; print(result[&quot;text&quot;])</span>
<span class="sd">        Let me search for that.</span>
<span class="sd">        &gt;&gt;&gt; print(result[&quot;calls&quot;][0].tool)</span>
<span class="sd">        search</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ParseResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse JSON-style function calls from response.</span>

<span class="sd">        Args:</span>
<span class="sd">            response (str | dict[str, Any]): The response to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ParseResult: Parsed result with message and tool calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="c1"># If it&#39;s not valid JSON, treat as plain text with no tools</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">ParseResult</span><span class="p">()</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;calls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="n">tools_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToolCall</span><span class="p">(</span><span class="o">**</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tools_data</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">ParseResult</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;calls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calls</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="ExecuteToolsInOrder"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.ExecuteToolsInOrder.html#torchrl.envs.llm.transforms.ExecuteToolsInOrder">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ExecuteToolsInOrder</span><span class="p">(</span><span class="n">ToolTransformBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Transform that executes tools in the order they appear in LLM output.</span>

<span class="sd">    This transform reads the LLM response, parses ordered tool blocks using a</span>
<span class="sd">    pluggable parser, and executes tools via a ToolRegistry strictly in the</span>
<span class="sd">    order they appear in the response (independent of transform stacking order).</span>

<span class="sd">    The transform integrates naturally with TorchRL&#39;s LLM environments and can</span>
<span class="sd">    read/write conversation history alongside other transforms.</span>

<span class="sd">    Args:</span>
<span class="sd">        registry (ToolRegistry): Registry containing available tool services.</span>
<span class="sd">        parser (LLMToolParser): Parser for extracting tool calls from LLM output.</span>
<span class="sd">        stop_on_error (bool, optional): Whether to stop execution on first error.</span>
<span class="sd">            Defaults to ``False``.</span>
<span class="sd">        pass_state_to_tools (bool, optional): Whether to pass TD state to tools.</span>
<span class="sd">            Defaults to ``True``.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs.llm import ChatEnv</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs.transforms import TransformedEnv, Compose</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs.llm.transforms import ExecuteToolsInOrder, ToolRegistry, XMLBlockParser</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Define a simple service</span>
<span class="sd">        &gt;&gt;&gt; class WebSearch:</span>
<span class="sd">        ...     name = &quot;search&quot;</span>
<span class="sd">        ...     schema_in = {&quot;query&quot;: str}</span>
<span class="sd">        ...     schema_out = {&quot;results&quot;: list}</span>
<span class="sd">        ...     def __call__(self, query: str, **kwargs):</span>
<span class="sd">        ...         return {&quot;results&quot;: [{&quot;title&quot;: &quot;TorchRL docs&quot;, &quot;url&quot;: &quot;https://...&quot;}]}</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Create registry and parser</span>
<span class="sd">        &gt;&gt;&gt; registry = ToolRegistry([WebSearch()])</span>
<span class="sd">        &gt;&gt;&gt; parser = XMLBlockParser()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Create environment with transform</span>
<span class="sd">        &gt;&gt;&gt; env = ChatEnv(batch_size=(1,))</span>
<span class="sd">        &gt;&gt;&gt; env = TransformedEnv(</span>
<span class="sd">        ...     env,</span>
<span class="sd">        ...     ExecuteToolsInOrder(registry=registry, parser=parser)</span>
<span class="sd">        ... )</span>

<span class="sd">    .. note::</span>
<span class="sd">        This transform operates in the forward direction only; inverse is a no-op.</span>
<span class="sd">        Tool execution order is determined by appearance in the LLM output,</span>
<span class="sd">        not by the order of transforms in the Compose stack.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_step</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Use _step() method</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">registry</span><span class="p">:</span> <span class="n">ToolRegistry</span><span class="p">,</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">LLMToolParser</span><span class="p">,</span>
        <span class="n">stop_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">pass_state_to_tools</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_on_error</span> <span class="o">=</span> <span class="n">stop_on_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pass_state_to_tools</span> <span class="o">=</span> <span class="n">pass_state_to_tools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_role</span> <span class="o">=</span> <span class="s2">&quot;tool&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process one batch item to extract and execute tools.</span>

<span class="sd">        This is the main method required by ToolTransformBase.</span>

<span class="sd">        Args:</span>
<span class="sd">            content: The text content from the LLM response.</span>
<span class="sd">            index: The index of this item in the batch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str] or None: List of result strings for each tool executed,</span>
<span class="sd">                or None if no tools were found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Parse the response for tool calls</span>
        <span class="n">parse</span><span class="p">:</span> <span class="n">ParseResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="n">ordered_calls</span> <span class="o">=</span> <span class="n">parse</span><span class="p">[</span><span class="s2">&quot;calls&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ordered_calls</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">tool_outputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Execute tools IN ORDER OF APPEARANCE</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">call</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_calls</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">tool</span><span class="p">)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_state_to_tools</span><span class="p">:</span>
                    <span class="c1"># Get tensordict from parent context if available</span>
                    <span class="c1"># For now, pass empty state - can be enhanced later</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">out</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;_tool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">tool</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;_tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">tag</span>
                <span class="n">tool_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_tool&quot;</span><span class="p">:</span> <span class="n">call</span><span class="o">.</span><span class="n">tool</span><span class="p">,</span> <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
                <span class="n">tool_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_on_error</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="c1"># Format tool results as a single string</span>
        <span class="c1"># Format tool results as a single string</span>
        <span class="k">if</span> <span class="n">tool_outputs</span><span class="p">:</span>
            <span class="n">results_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_tool_results</span><span class="p">(</span><span class="n">tool_outputs</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">results_text</span><span class="p">]</span> <span class="k">if</span> <span class="n">results_text</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_tool_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_outputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format tool execution results as text.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool_outputs (list[dict[str, Any]]): List of tool execution results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Formatted text representation of results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_outputs</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;tool_results&gt;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">tool_outputs</span><span class="p">:</span>
            <span class="n">tool_name</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_tool&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_index&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_tag&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> (call </span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">) failed:&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Error: </span><span class="si">{</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> (call </span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; [tag: </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s2">&quot; succeeded:&quot;</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Result: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;/tool_results&gt;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<span class="k">class</span><span class="w"> </span><span class="nc">PersistentPythonProcess</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A persistent Python process that can execute code blocks.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accumulated_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_script</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize to None to avoid AttributeError in __del__</span>

        <span class="c1"># Start the process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_process</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_start_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the Python process with the initialization script.&quot;&quot;&quot;</span>
        <span class="c1"># Create a temporary file for initialization</span>
        <span class="n">init_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_script</span> <span class="o">=</span> <span class="n">init_file</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Write a script that creates a continuous execution environment</span>
        <span class="n">init_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">import sys</span>
<span class="sd">import traceback</span>

<span class="sd">def run_code(code_str):</span>
<span class="sd">    # Create a dictionary to store the local variables</span>
<span class="sd">    locals_dict = {}</span>
<span class="sd">    try:</span>
<span class="sd">        # First try to compile the code to catch syntax errors</span>
<span class="sd">        compiled = compile(code_str, &#39;&lt;string&gt;&#39;, &#39;exec&#39;)</span>
<span class="sd">        # Execute the code with the locals dictionary</span>
<span class="sd">        exec(compiled, globals(), locals_dict)</span>
<span class="sd">        # Ensure output is flushed</span>
<span class="sd">        sys.stdout.flush()</span>
<span class="sd">        sys.stderr.flush()</span>
<span class="sd">        return locals_dict</span>
<span class="sd">    except Exception as e:</span>
<span class="sd">        print(f&quot;Error: {str(e)}&quot;, file=sys.stderr)</span>
<span class="sd">        print(&quot;Traceback:&quot;, file=sys.stderr)</span>
<span class="sd">        traceback.print_exc(file=sys.stderr)</span>
<span class="sd">        # Ensure error output is flushed immediately</span>
<span class="sd">        sys.stdout.flush()</span>
<span class="sd">        sys.stderr.flush()</span>
<span class="sd">        return locals_dict</span>

<span class="sd"># Signal that we&#39;re ready to accept commands</span>
<span class="sd">print(&#39;---READY---&#39;)</span>
<span class="sd">sys.stdout.flush()</span>

<span class="sd"># Main loop to handle commands</span>
<span class="sd">while True:</span>
<span class="sd">    try:</span>
<span class="sd">        # Read a line that signals the start of a command</span>
<span class="sd">        line = input()</span>
<span class="sd">        if line.strip() == &#39;---EXEC---&#39;:</span>
<span class="sd">            # Read the code until we see the end marker</span>
<span class="sd">            code_lines = []</span>
<span class="sd">            while True:</span>
<span class="sd">                line = input()</span>
<span class="sd">                if line.strip() == &#39;---END---&#39;:</span>
<span class="sd">                    break</span>
<span class="sd">                code_lines.append(line)</span>

<span class="sd">            # Execute the code</span>
<span class="sd">            code_str = &#39;\\n&#39;.join(code_lines)</span>
<span class="sd">            print(&#39;---START---&#39;)  # Signal start of execution</span>
<span class="sd">            sys.stdout.flush()</span>
<span class="sd">            locals_dict = run_code(code_str)</span>
<span class="sd">            # Update globals with new locals for persistence</span>
<span class="sd">            globals().update(locals_dict)</span>
<span class="sd">            print(&#39;---END---&#39;)  # Signal end of execution</span>
<span class="sd">            # Ensure all output is flushed</span>
<span class="sd">            sys.stdout.flush()</span>
<span class="sd">            sys.stderr.flush()</span>
<span class="sd">    except (EOFError, KeyboardInterrupt):</span>
<span class="sd">        break</span>
<span class="sd">    except Exception as e:</span>
<span class="sd">        print(f&quot;Fatal error: {str(e)}&quot;, file=sys.stderr)</span>
<span class="sd">        sys.stderr.flush()</span>
<span class="sd">        break</span>
<span class="sd">&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">init_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Start the process</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_script</span><span class="p">],</span>  <span class="c1"># -u for unbuffered output</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bufsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Start output reading threads</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_output</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_queue</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">),</span>
                <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_output</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_queue</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">),</span>
                <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># Wait for the process to be ready</span>
            <span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="k">while</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Process failed to start: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                    <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;---READY---&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">ready</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="n">timeout</span> <span class="o">-=</span> <span class="mf">0.1</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Process failed to initialize within timeout&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Clean up if process creation failed</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_script</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_script</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_init_script</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipe</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read output from a pipe and put it in a queue.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pipe_name</span> <span class="o">==</span> <span class="s2">&quot;stderr&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_accumulated_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Pipe has been closed</span>
            <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipe_name</span><span class="si">}</span><span class="s2"> pipe closed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pipe</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute code in the persistent process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get any accumulated errors</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accumulated_errors</span><span class="p">)</span>
            <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Process state: poll=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No process&#39;</span><span class="si">}</span><span class="s2">, accumulated errors: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Process not initialized or terminated. Accumulated errors: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="s2">&quot;Process stdin not available&quot;</span><span class="p">,</span>
                <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Clear accumulated errors before new execution</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accumulated_errors</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># Send the execution markers and code</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;---EXEC---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing to stdin: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;---END---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write to stdin: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to write to process: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Collect output until we see the end marker</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start_found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">timeout_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>

            <span class="k">while</span> <span class="n">timeout_val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Process has terminated - get accumulated errors</span>
                    <span class="n">errors</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accumulated_errors</span><span class="p">)</span>
                    <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Process terminated with return code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2"> - accumulated errors: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Process terminated with return code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Check for errors first</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Drain all available error output</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                            <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="c1"># Then check for output</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                        <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;---START---&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">start_found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="s2">&quot;---END---&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">start_found</span><span class="p">:</span>
                            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="c1"># Always sleep a bit to avoid busy-waiting and give subprocess time</span>
                    <span class="n">timeout_val</span> <span class="o">-=</span> <span class="mf">0.01</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Execution error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">}</span>

            <span class="k">if</span> <span class="n">timeout_val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Kill the process and create a new one</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="s2">&quot;Code execution timed out - process restarted&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">),</span>
                <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
                <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># If we encounter any error, restart the process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Execution error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2"> - process restarted&quot;</span><span class="p">,</span>
                <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up the persistent process.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Clean up the init script</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_script</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_script</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_script</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure cleanup on deletion.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>


<div class="viewcode-block" id="PythonExecutorService"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.PythonExecutorService.html#torchrl.envs.llm.transforms.PythonExecutorService">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">PythonExecutorService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ray actor that manages a pool of persistent Python interpreters.</span>

<span class="sd">    This service allows multiple environments to share a pool of Python</span>
<span class="sd">    interpreters, reducing resource usage and improving efficiency.</span>

<span class="sd">    Args:</span>
<span class="sd">        pool_size (int): Number of Python interpreter processes to maintain.</span>
<span class="sd">        timeout (float): Timeout for code execution in seconds.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Register the service</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.services import get_services</span>
<span class="sd">        &gt;&gt;&gt; services = get_services(backend=&quot;ray&quot;)</span>
<span class="sd">        &gt;&gt;&gt; services.register(</span>
<span class="sd">        ...     &quot;python_executor&quot;,</span>
<span class="sd">        ...     PythonExecutorService,</span>
<span class="sd">        ...     pool_size=32,</span>
<span class="sd">        ...     timeout=10.0,</span>
<span class="sd">        ...     num_cpus=32,</span>
<span class="sd">        ...     max_concurrency=32</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Use in transform</span>
<span class="sd">        &gt;&gt;&gt; env = env.append_transform(</span>
<span class="sd">        ...     PythonInterpreter(services=&quot;ray&quot;)</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span> <span class="o">=</span> <span class="n">pool_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">PersistentPythonProcess</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pool_size</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># Create a lock for each process to prevent concurrent access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_locks</span> <span class="o">=</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pool_size</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selection_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<div class="viewcode-block" id="PythonExecutorService.execute"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.PythonExecutorService.html#torchrl.envs.llm.transforms.PythonExecutorService.execute">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute Python code using next available process (round-robin).</span>

<span class="sd">        Args:</span>
<span class="sd">            code: Python code to execute.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Execution result with keys &#39;success&#39;, &#39;stdout&#39;, &#39;stderr&#39;, &#39;returncode&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Select a process using round-robin</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selection_lock</span><span class="p">:</span>
            <span class="n">process_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span>

        <span class="c1"># Lock the selected process for the duration of execution</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_locks</span><span class="p">[</span><span class="n">process_idx</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="n">process_idx</span><span class="p">]</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span></div>

<div class="viewcode-block" id="PythonExecutorService.cleanup"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.PythonExecutorService.html#torchrl.envs.llm.transforms.PythonExecutorService.cleanup">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cleanup all processes in the pool.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;processes&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">process</span><span class="p">:</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure cleanup on deletion.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Ignore errors during cleanup - we might be in Ray actor context</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="PythonInterpreter"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.PythonInterpreter.html#torchrl.envs.llm.transforms.PythonInterpreter">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">PythonInterpreter</span><span class="p">(</span><span class="n">ToolTransformBase</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;A transform that executes Python code in the LLM response.</span>

<span class="sd">    This transform inherits from :class:`ToolTransformBase` and handles all the</span>
<span class="sd">    boilerplate for history extraction, batch processing, and result injection.</span>

<span class="sd">    Args:</span>
<span class="sd">        tokenizer: The tokenizer to use. Defaults to `None` (no tokenizer).</span>
<span class="sd">        tool_name: The name of the tool in the chat history. Defaults to `&quot;tool&quot;`.</span>
<span class="sd">        persistent: Whether to use persistent processes. Defaults to `False`.</span>
<span class="sd">        timeout: The timeout for the persistent processes. Defaults to `10.0`.</span>
<span class="sd">        services: Backend for shared Python executor service. If `&quot;ray&quot;`, uses</span>
<span class="sd">            a shared Ray actor service for execution. If `None`, uses local</span>
<span class="sd">            processes. Defaults to `None`.</span>
<span class="sd">        service_name: Name of the service in the registry. Only used if</span>
<span class="sd">            `services=&quot;ray&quot;`. Defaults to `&quot;python_executor&quot;`.</span>
<span class="sd">        namespace: Ray namespace for the service. Only used if `services=&quot;ray&quot;`.</span>
<span class="sd">            If `None`, uses the default namespace. Defaults to `None`.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs.llm.transforms import PythonInterpreter</span>
<span class="sd">        &gt;&gt;&gt; from transformers import AutoTokenizer</span>
<span class="sd">        &gt;&gt;&gt; from tensordict import TensorDict, set_list_to_stack</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs.llm import ChatEnv</span>
<span class="sd">        &gt;&gt;&gt; set_list_to_stack(True).set()</span>
<span class="sd">        &gt;&gt;&gt; tokenizer = AutoTokenizer.from_pretrained(&quot;Qwen/Qwen2.5-3B&quot;)</span>
<span class="sd">        &gt;&gt;&gt; env = ChatEnv(</span>
<span class="sd">        ...     batch_size=(1,),</span>
<span class="sd">        ...     system_prompt=&quot;I&#39;m the system, do as I say&quot;,</span>
<span class="sd">        ...     apply_template=True,</span>
<span class="sd">        ...     tokenizer=tokenizer,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; env = env.append_transform(PythonInterpreter())</span>
<span class="sd">        &gt;&gt;&gt; r = env.reset(TensorDict(text=[&quot;This is the user prompt&quot;], batch_size=(1,)))</span>
<span class="sd">        &gt;&gt;&gt; r[&quot;text_response&quot;] = [&quot;Here is a python code to execute:\n```python\na=1\nprint(f&#39;{a=}&#39;)\n```&lt;|im_end|&gt;\n&quot;]</span>
<span class="sd">        &gt;&gt;&gt; s = env.step(r)</span>
<span class="sd">        &gt;&gt;&gt; print(s[&#39;next&#39;, &#39;history&#39;].apply_chat_template(tokenizer=tokenizer))</span>
<span class="sd">        [&#39;&lt;|im_start|&gt;system\n&#39;</span>
<span class="sd">         &quot;I&#39;m the system, do as I say&lt;|im_end|&gt;\n&quot;</span>
<span class="sd">         &#39;&lt;|im_start|&gt;user\n&#39;</span>
<span class="sd">         &#39;This is the user prompt&lt;|im_end|&gt;\n&#39;</span>
<span class="sd">         &#39;&lt;|im_start|&gt;assistant\n&#39;</span>
<span class="sd">         &#39;Here is a python code to execute:\n&#39;</span>
<span class="sd">         &#39;```python\n&#39;</span>
<span class="sd">         &#39;a=1\n&#39;</span>
<span class="sd">         &quot;print(f&#39;{a=}&#39;)\n&quot;</span>
<span class="sd">         &#39;```&lt;|im_end|&gt;\n&#39;</span>
<span class="sd">         &#39;&lt;|im_start|&gt;user\n&#39;</span>
<span class="sd">         &#39;&lt;tool_response&gt;\n&#39;</span>
<span class="sd">         &#39;Code block 1 executed successfully:\n&#39;</span>
<span class="sd">         &#39;a=1\n&#39;</span>
<span class="sd">         &#39;\n&#39;</span>
<span class="sd">         &#39;&lt;/tool_response&gt;&lt;|im_end|&gt;\n&#39;</span>
<span class="sd">         &#39;&lt;|im_start|&gt;assistant\n&#39;]</span>

<span class="sd">        Using shared Ray service:</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.services import get_services</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Register service once (e.g., in main process)</span>
<span class="sd">        &gt;&gt;&gt; services = get_services(backend=&quot;ray&quot;)</span>
<span class="sd">        &gt;&gt;&gt; if &quot;python_executor&quot; not in services:</span>
<span class="sd">        ...     services.register(</span>
<span class="sd">        ...         &quot;python_executor&quot;,</span>
<span class="sd">        ...         PythonExecutorService,</span>
<span class="sd">        ...         pool_size=32,</span>
<span class="sd">        ...         timeout=10.0,</span>
<span class="sd">        ...         num_cpus=32,</span>
<span class="sd">        ...         max_concurrency=32</span>
<span class="sd">        ...     )</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Use in transform (all 128 envs share the 32 interpreters)</span>
<span class="sd">        &gt;&gt;&gt; env = env.append_transform(PythonInterpreter(services=&quot;ray&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_step</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Use _step() method</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
        <span class="n">persistent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">services</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;python_executor&quot;</span><span class="p">,</span>
        <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_role</span> <span class="o">=</span> <span class="n">tool_name</span>  <span class="c1"># Set the role for history entries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persistent</span> <span class="o">=</span> <span class="n">persistent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="n">services</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_name</span> <span class="o">=</span> <span class="n">service_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span>

        <span class="c1"># Initialize attributes to avoid AttributeError in __del__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">python_service</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Initialize based on service mode</span>
        <span class="k">if</span> <span class="n">services</span> <span class="o">==</span> <span class="s2">&quot;ray&quot;</span><span class="p">:</span>
            <span class="c1"># Use shared Ray service</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.services</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_services</span>

                <span class="n">service_registry</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">python_service</span> <span class="o">=</span> <span class="n">service_registry</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PythonInterpreter using Ray service &#39;</span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to get Ray service &#39;</span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Make sure the service is registered. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">elif</span> <span class="n">services</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use local processes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">python_service</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">persistent</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid services backend: </span><span class="si">{</span><span class="n">services</span><span class="si">}</span><span class="s2">. Must be &#39;ray&#39; or None.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="PythonInterpreter.close"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.PythonInterpreter.html#torchrl.envs.llm.transforms.PythonInterpreter.close">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the transform.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_service</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">process</span><span class="p">:</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="PythonInterpreter.clone"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.PythonInterpreter.html#torchrl.envs.llm.transforms.PythonInterpreter.clone">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clone the transform.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_role</span><span class="p">,</span>  <span class="c1"># tool_role is the instance attribute</span>
            <span class="n">persistent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">persistent</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">services</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">,</span>
            <span class="n">service_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service_name</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure we have the right number of persistent processes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create new processes if needed</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PersistentPythonProcess</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">p</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">PersistentPythonProcess</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span>
            <span class="p">]</span>

        <span class="c1"># Remove extra processes if batch size decreased</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Too many processes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_python_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely execute Python code and return results.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_service</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use shared Ray service</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">ray</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">python_service</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Ray service execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent</span><span class="p">:</span>
            <span class="c1"># Use local persistent process</span>
            <span class="c1"># Ensure we have enough processes</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_processes</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Use persistent process</span>
            <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">process</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="s2">&quot;Process not initialized&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="n">process</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use temporary file approach</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">temp_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">temp_file</span><span class="p">],</span>
                    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                    <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="s2">&quot;Code execution timed out&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stderr&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_python_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract Python code blocks from markdown-style formatting.&quot;&quot;&quot;</span>
        <span class="c1"># Pattern to match ```python ... ``` blocks</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;```python\n(.*?)\n```&quot;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matches</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process one batch item to extract and execute Python code.</span>

<span class="sd">        This is the main method required by ToolTransformBase.</span>

<span class="sd">        Args:</span>
<span class="sd">            content: The text content from the LLM response.</span>
<span class="sd">            index: The index of this item in the batch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str] or None: List of result strings for each code block executed,</span>
<span class="sd">                or None if no code blocks were found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure we have enough processes for persistent mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_processes</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Extract code blocks</span>
        <span class="n">code_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_python_code</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code_blocks</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Execute each code block</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">block_idx</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">code_blocks</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_python_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Code block </span><span class="si">{</span><span class="n">block_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> executed successfully:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Code block </span><span class="si">{</span><span class="n">block_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> failed:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span> <span class="k">if</span> <span class="n">results</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span><span class="p">,</span> <span class="n">next_tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDictBase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override to handle batch size management for persistent processes.&quot;&quot;&quot;</span>
        <span class="c1"># Ensure we have enough processes for the entire batch (only for local persistent mode)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">python_service</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent</span>
            <span class="ow">and</span> <span class="n">next_tensordict</span><span class="o">.</span><span class="n">batch_dims</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_processes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">next_tensordict</span><span class="p">))</span>

        <span class="c1"># Delegate to base class for all the heavy lifting</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_step</span><span class="p">(</span><span class="n">tensordict</span><span class="p">,</span> <span class="n">next_tensordict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure cleanup on deletion.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;python_service&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_service</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;processes&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">process</span><span class="p">:</span>
                            <span class="n">process</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Ignore errors during cleanup</span>
            <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span><span class="p">,</span> <span class="n">tensordict_reset</span><span class="p">:</span> <span class="n">TensorDictBase</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDictBase</span><span class="p">:</span>
        <span class="c1"># Get the &#39;_reset&#39; key from the tensordict_reset</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_reset&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reset</span> <span class="o">=</span> <span class="n">reset</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">tensordict</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                <span class="n">tensordict</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tensordict</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span>
            <span class="p">)</span>

        <span class="c1"># Only reset local persistent processes, not the shared service</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_service</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">process</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">reset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">process</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span> <span class="n">PersistentPythonProcess</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">process</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">tensordict_reset</span></div>


<div class="viewcode-block" id="SimpleToolTransform"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.SimpleToolTransform.html#torchrl.envs.llm.transforms.SimpleToolTransform">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">SimpleToolTransform</span><span class="p">(</span><span class="n">ToolTransformBase</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;A simple transform that executes tools from a dictionary of callables.</span>

<span class="sd">    This is a lightweight alternative to MCPToolTransform for simple use cases</span>
<span class="sd">    where you don&#39;t need the full Model Context Protocol infrastructure.</span>

<span class="sd">    Args:</span>
<span class="sd">        tools (dict[str, Callable]): Dictionary mapping tool names to their implementation functions.</span>
<span class="sd">            Each function should accept kwargs matching its expected parameters.</span>
<span class="sd">        tool_schemas (dict[str, dict], optional): Dictionary mapping tool names to their schemas.</span>
<span class="sd">            Used for documentation purposes only.</span>
<span class="sd">        parser (LLMToolParser | None, optional): Parser for extracting tool calls. If None,</span>
<span class="sd">            uses a simple XML-style parser. Defaults to None.</span>
<span class="sd">        tool_call_pattern (str | None, optional): Regex pattern for extracting tool calls.</span>
<span class="sd">            Only used if parser is None. Format should capture (tool_name, args_json).</span>
<span class="sd">            Defaults to ``r&quot;&lt;tool&gt;(.*?)\\n(.*?)&lt;/tool&gt;&quot;``.</span>
<span class="sd">        tool_name (str, optional): Role name for tool results in history. Defaults to &quot;tool&quot;.</span>
<span class="sd">        timeout (float, optional): Timeout for tool execution in seconds. Defaults to 10.0.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs.llm.transforms import SimpleToolTransform, XMLBlockParser</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs.llm import ChatEnv</span>
<span class="sd">        &gt;&gt;&gt; from tensordict import TensorDict, set_list_to_stack</span>
<span class="sd">        &gt;&gt;&gt; set_list_to_stack(True).set()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Define a simple tool</span>
<span class="sd">        &gt;&gt;&gt; def calculator(operation: str, a: float, b: float):</span>
<span class="sd">        ...     if operation == &quot;add&quot;:</span>
<span class="sd">        ...         return {&quot;result&quot;: a + b}</span>
<span class="sd">        ...     return {&quot;error&quot;: &quot;unknown operation&quot;}</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; tools = {&quot;calculator&quot;: calculator}</span>
<span class="sd">        &gt;&gt;&gt; env = ChatEnv(batch_size=(1,))</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Option 1: Use default XML-style pattern</span>
<span class="sd">        &gt;&gt;&gt; env = env.append_transform(SimpleToolTransform(tools=tools))</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Option 2: Use XMLBlockParser for more features</span>
<span class="sd">        &gt;&gt;&gt; parser = XMLBlockParser()</span>
<span class="sd">        &gt;&gt;&gt; env = env.append_transform(SimpleToolTransform(tools=tools, parser=parser))</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Option 3: Custom pattern</span>
<span class="sd">        &gt;&gt;&gt; env = env.append_transform(</span>
<span class="sd">        ...     SimpleToolTransform(</span>
<span class="sd">        ...         tools=tools,</span>
<span class="sd">        ...         tool_call_pattern=r&quot;CALL\[(.*?)\]\((.*?)\)&quot;</span>
<span class="sd">        ...     )</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_step</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">],</span>
        <span class="n">tool_schemas</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">LLMToolParser</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_call_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_schemas</span> <span class="o">=</span> <span class="n">tool_schemas</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_call_pattern</span> <span class="o">=</span> <span class="n">tool_call_pattern</span> <span class="ow">or</span> <span class="sa">r</span><span class="s2">&quot;&lt;tool&gt;(.*?)\n(.*?)&lt;/tool&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_role</span> <span class="o">=</span> <span class="n">tool_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract tool calls from text.</span>

<span class="sd">        Uses parser if provided, otherwise falls back to regex pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use the parser (e.g., XMLBlockParser)</span>
            <span class="n">result</span><span class="p">:</span> <span class="n">ParseResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calls&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">call</span><span class="o">.</span><span class="n">tool</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">))</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use regex pattern</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_call_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">matches</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a tool with the given arguments.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Parse arguments</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to parse tool arguments: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Execute tool</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">tool_name</span><span class="p">](</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Tool execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process one batch item to extract and execute simple tools.&quot;&quot;&quot;</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tool_calls</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tool_name</span><span class="p">,</span> <span class="n">args_json</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">args_json</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> executed successfully:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> failed:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span> <span class="k">if</span> <span class="n">results</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MCPToolTransform"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.MCPToolTransform.html#torchrl.envs.llm.transforms.MCPToolTransform">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">MCPToolTransform</span><span class="p">(</span><span class="n">ToolTransformBase</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;A transform that executes tools via the Model Context Protocol (MCP).</span>

<span class="sd">    This transform connects to MCP servers and executes tools through the official</span>
<span class="sd">    MCP library. It runs async operations in a background thread to work with</span>
<span class="sd">    TorchRL&#39;s synchronous transform API.</span>

<span class="sd">    Args:</span>
<span class="sd">        servers (dict[str, dict]): Dictionary mapping server names to their configurations.</span>
<span class="sd">            Each config should have:</span>
<span class="sd">            - &quot;command&quot; (str): Command to launch the server (e.g., &quot;npx&quot;, &quot;uvx&quot;)</span>
<span class="sd">            - &quot;args&quot; (list[str]): Arguments for the command</span>
<span class="sd">            Example: {&quot;browser&quot;: {&quot;command&quot;: &quot;npx&quot;, &quot;args&quot;: [&quot;@browsermcp/mcp@latest&quot;]}}</span>
<span class="sd">        tool_call_pattern (str, optional): Regex pattern for extracting tool calls.</span>
<span class="sd">            Should capture (tool_name_with_server, args_json).</span>
<span class="sd">            Defaults to ``r&quot;&lt;tool&gt;([\\w.]+)\\n(.*?)&lt;/tool&gt;&quot;``.</span>
<span class="sd">        tool_name (str, optional): Role name for tool results in history. Defaults to &quot;tool&quot;.</span>
<span class="sd">        timeout (float, optional): Timeout for tool execution in seconds. Defaults to 10.0.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; import json</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs.llm import ChatEnv</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs.llm.transforms import MCPToolTransform</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.data.llm import History</span>
<span class="sd">        &gt;&gt;&gt; from tensordict import TensorDict, set_list_to_stack</span>
<span class="sd">        &gt;&gt;&gt; set_list_to_stack(True).set()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Add Deno to PATH (required for mcp-run-python)</span>
<span class="sd">        &gt;&gt;&gt; environ = os.environ.copy()</span>
<span class="sd">        &gt;&gt;&gt; deno_path = os.path.expanduser(&quot;~/.deno/bin&quot;)</span>
<span class="sd">        &gt;&gt;&gt; if deno_path not in os.environ.get(&#39;PATH&#39;, &#39;&#39;):</span>
<span class="sd">        ...     environ[&#39;PATH&#39;] = f&quot;{deno_path}:{os.environ[&#39;PATH&#39;]}&quot;</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Define MCP servers</span>
<span class="sd">        &gt;&gt;&gt; servers = {</span>
<span class="sd">        ...     &quot;browser&quot;: {</span>
<span class="sd">        ...         &quot;command&quot;: &quot;npx&quot;,</span>
<span class="sd">        ...         &quot;args&quot;: [&quot;@browsermcp/mcp@latest&quot;]</span>
<span class="sd">        ...     },</span>
<span class="sd">        ...     &quot;python&quot;: {</span>
<span class="sd">        ...         &quot;command&quot;: &quot;uvx&quot;,</span>
<span class="sd">        ...         &quot;args&quot;: [&quot;mcp-run-python&quot;, &quot;stdio&quot;],</span>
<span class="sd">        ...         &quot;env&quot;: environ</span>
<span class="sd">        ...     }</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Create environment with MCP transform</span>
<span class="sd">        &gt;&gt;&gt; env = ChatEnv(batch_size=(1,))</span>
<span class="sd">        &gt;&gt;&gt; env = env.append_transform(MCPToolTransform(servers=servers))  # doctest: +SKIP</span>
<span class="sd">        [torchrl][INFO] Connecting to MCP server &#39;browser&#39; (npx @browsermcp/mcp@latest)</span>
<span class="sd">        [torchrl][INFO] Connected to MCP server &#39;browser&#39; with 12 tools</span>
<span class="sd">        [torchrl][INFO] Connecting to MCP server &#39;python&#39; (uvx mcp-run-python stdio)</span>
<span class="sd">        [torchrl][INFO] Connected to MCP server &#39;python&#39; with 1 tools</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Execute Python code via MCP</span>
<span class="sd">        &gt;&gt;&gt; reset_data = TensorDict(query=&quot;You are a useful assistant&quot;, batch_size=(1,))</span>
<span class="sd">        &gt;&gt;&gt; td = env.reset(reset_data)</span>
<span class="sd">        &gt;&gt;&gt; history = td.get(&quot;history&quot;)</span>
<span class="sd">        &gt;&gt;&gt; code = &#39;&#39;&#39;</span>
<span class="sd">        ... import math</span>
<span class="sd">        ... result = math.sqrt(144) + math.pi</span>
<span class="sd">        ... print(f&quot;Result: {result}&quot;)</span>
<span class="sd">        ... result</span>
<span class="sd">        ... &#39;&#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; response = History(</span>
<span class="sd">        ...     role=&quot;assistant&quot;,</span>
<span class="sd">        ...     content=f&#39;Let me calculate that.\n&lt;tool&gt;python.run_python_code\n{json.dumps({&quot;python_code&quot;: code})}&lt;/tool&gt;&#39;,</span>
<span class="sd">        ... ).unsqueeze(0).unsqueeze(0)</span>
<span class="sd">        &gt;&gt;&gt; history.full = history.prompt.extend(response, inplace=True, dim=-1)</span>
<span class="sd">        &gt;&gt;&gt; history.response = response</span>
<span class="sd">        &gt;&gt;&gt; result = env.step(td.set(&quot;history&quot;, history))  # doctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; print(result[&quot;next&quot;, &quot;history&quot;, &quot;prompt&quot;][..., -1].content)  # doctest: +SKIP</span>
<span class="sd">        LinkedList(LinkedList([&quot;Tool python.run_python_code executed successfully:\n[TextContent(type=&#39;text&#39;, text=&#39;&lt;status&gt;success&lt;/status&gt;\\n&lt;output&gt;\\nResult: 15.141592653589793\\n&lt;/output&gt;\\n&lt;return_value&gt;\\n15.141592653589793\\n&lt;/return_value&gt;&#39;, annotations=None, meta=None)]&quot;]))</span>

<span class="sd">    .. note::</span>
<span class="sd">        This requires the `mcp` package to be installed: `pip install mcp`</span>
<span class="sd">        The transform manages async MCP connections in a background thread.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Some MCP servers have additional requirements:</span>
<span class="sd">        - `mcp-run-python` requires Deno: `curl -fsSL https://deno.land/install.sh | sh`</span>
<span class="sd">        - Server-specific dependencies should be installed before use</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_step</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Use _step() method</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">servers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
        <span class="n">tool_call_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span> <span class="o">=</span> <span class="n">servers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_call_pattern</span> <span class="o">=</span> <span class="n">tool_call_pattern</span> <span class="ow">or</span> <span class="sa">r</span><span class="s2">&quot;&lt;tool&gt;([\w.]+)\n(.*?)&lt;/tool&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_role</span> <span class="o">=</span> <span class="n">tool_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>

        <span class="c1"># MCP session management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tools_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_error</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Start the async event loop in a background thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_mcp_thread</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_start_mcp_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a background thread running an async event loop for MCP, since it&#39;s made of coroutines.&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">run_loop</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connection_error</span> <span class="o">=</span> <span class="s2">&quot;asyncio not available for MCPToolTransform&quot;</span>
                <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_error</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ready_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>

                <span class="c1"># Connect to all MCP servers</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connect_servers</span><span class="p">())</span>

                <span class="c1"># Signal that initialization is complete</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ready_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="c1"># Keep loop running until shutdown</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

                <span class="c1"># Cleanup</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_servers</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connection_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MCP thread failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_error</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ready_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Wait for initialization to complete (with timeout)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
            <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MCP initialization timed out after 10 seconds&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_error</span><span class="p">:</span>
            <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;MCP initialization had errors: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_error</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_connect_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect to all configured MCP servers.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">mcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientSession</span><span class="p">,</span> <span class="n">StdioServerParameters</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">mcp.client.stdio</span><span class="w"> </span><span class="kn">import</span> <span class="n">stdio_client</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;MCP library not installed. Install with: pip install mcp</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create stdio transport</span>
                <span class="n">server_params</span> <span class="o">=</span> <span class="n">StdioServerParameters</span><span class="p">(</span>
                    <span class="n">command</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">],</span>
                    <span class="n">args</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="n">env</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connecting to MCP server &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Connect and initialize session</span>
                <span class="n">stdio</span> <span class="o">=</span> <span class="n">stdio_client</span><span class="p">(</span><span class="n">server_params</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">read</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stdio</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="s2">&quot;deno&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span>
                        <span class="ow">or</span> <span class="s2">&quot;no such file or directory: &#39;deno&#39;&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span>
                    <span class="p">):</span>
                        <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to start stdio for &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: Deno is not installed.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  Install Deno: curl -fsSL https://deno.land/install.sh | sh</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  After installing, restart your terminal/shell.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to start stdio for &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">raise</span>

                <span class="n">session</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;connection closed&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                        <span class="c1"># Subprocess likely crashed - check for common issues</span>
                        <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to initialize session for &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: Subprocess terminated.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  The MCP server &#39;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; started but immediately crashed.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  Common causes:</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;    - Missing dependencies (e.g., Deno for mcp-run-python)</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;    - Invalid server configuration</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  Try running manually: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to initialize session for &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="c1"># Try to close stdio</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">stdio</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">raise</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span>
                    <span class="s2">&quot;stdio&quot;</span><span class="p">:</span> <span class="n">stdio</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># Discover tools</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tools_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">list_tools</span><span class="p">()</span>
                    <span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools_response</span><span class="o">.</span><span class="n">tools</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tools_cache</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span>
                    <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Connected to MCP server &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39; with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span><span class="si">}</span><span class="s2"> tools&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;connection closed&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                        <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Could not list tools for server &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: Connection closed.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  The MCP server started but crashed immediately.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  This often means missing dependencies (e.g., Deno for mcp-run-python).</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  Test manually: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;  For mcp-run-python, install Deno: curl -fsSL https://deno.land/install.sh | sh&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Could not list tools for server &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tools_cache</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># Don&#39;t keep a session we can&#39;t list tools from</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">stdio</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="n">server_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">server_name</span><span class="p">]</span>

            <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Check if it&#39;s a Deno dependency issue</span>
                <span class="k">if</span> <span class="s2">&quot;deno&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to connect to MCP server &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: Deno is not installed.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;  Install Deno: curl -fsSL https://deno.land/install.sh | sh</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;  Or use a different MCP server that doesn&#39;t require Deno.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;  Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to connect to MCP server &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: Command not found.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;  Make sure &#39;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; is installed and in your PATH.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;  Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to connect to MCP server &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_disconnect_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disconnect from all MCP servers.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">server_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">server_data</span><span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">]</span>
                <span class="n">stdio</span> <span class="o">=</span> <span class="n">server_data</span><span class="p">[</span><span class="s2">&quot;stdio&quot;</span><span class="p">]</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">stdio</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">torchrl_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error disconnecting from &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tools_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Extract tool calls from text in format &lt;tool&gt;server.tool_name\nargs_json&lt;/tool&gt;.&quot;&quot;&quot;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_call_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

        <span class="c1"># Parse into (server_name, tool_name, args_json)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">full_name</span><span class="p">,</span> <span class="n">args_json</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">full_name</span><span class="p">:</span>
                <span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span> <span class="o">=</span> <span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Default to first server if no prefix</span>
                <span class="n">server_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_configs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">tool_name</span> <span class="o">=</span> <span class="n">full_name</span>

            <span class="k">if</span> <span class="n">server_name</span><span class="p">:</span>
                <span class="n">parsed</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">,</span> <span class="n">args_json</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">parsed</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_tool_sync</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a tool via MCP (blocking call that schedules async work).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;MCP thread not running&quot;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Schedule the async call in the background thread</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_tool_async</span><span class="p">(</span><span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">,</span> <span class="n">args_json</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Tool execution timed out after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Tool execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_tool_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args_json</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a tool via MCP (async implementation).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check if server exists</span>
            <span class="k">if</span> <span class="n">server_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;MCP server &#39;</span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&#39; not connected&quot;</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">[</span><span class="n">server_name</span><span class="p">][</span><span class="s2">&quot;session&quot;</span><span class="p">]</span>

            <span class="c1"># Parse arguments</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">args_json</span><span class="p">)</span> <span class="k">if</span> <span class="n">args_json</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to parse tool arguments: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Call the tool via MCP</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">call_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;MCP tool call failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process one batch item to extract and execute MCP tools.</span>

<span class="sd">        This is the main method required by ToolTransformBase.</span>

<span class="sd">        Args:</span>
<span class="sd">            content: The text content from the LLM response.</span>
<span class="sd">            index: The index of this item in the batch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str] or None: List of result strings for each tool executed,</span>
<span class="sd">                or None if no tools were found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract tool calls</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tool_calls</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Execute each tool via MCP</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">,</span> <span class="n">args_json</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_tool_sync</span><span class="p">(</span><span class="n">server_name</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">,</span> <span class="n">args_json</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> executed successfully:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">server_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> failed:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span> <span class="k">if</span> <span class="n">results</span> <span class="k">else</span> <span class="kc">None</span>

<div class="viewcode-block" id="MCPToolTransform.close"><a class="viewcode-back" href="../../../../../reference/generated/torchrl.envs.llm.transforms.MCPToolTransform.html#torchrl.envs.llm.transforms.MCPToolTransform.close">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shutdown the MCP connections and background thread.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure cleanup on deletion.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Meta.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>


        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
         <script src="../../../../../_static/jquery.js"></script>
         <script src="../../../../../_static/underscore.js"></script>
         <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../../../_static/doctools.js"></script>
         <script src="../../../../../_static/design-tabs.js"></script>
     

  

  <script type="text/javascript" src="../../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
     
    <script type="text/javascript">
      $(document).ready(function() {
	  var downloadNote = $(".sphx-glr-download-link-note.admonition.note");
	  if (downloadNote.length >= 1) {
	      var tutorialUrl = $("#tutorial-type").text();
	      var githubLink = "https://github.com/pytorch/rl/blob/main/tutorials/sphinx-"  + tutorialUrl + ".py",
		  notebookLink = $(".sphx-glr-download-jupyter").find(".download.reference")[0].href,
		  notebookDownloadPath = notebookLink.split('_downloads')[1],
		  colabLink = "https://colab.research.google.com/github/pytorch/rl/blob/gh-pages/main/_downloads" + notebookDownloadPath;

	      $(".pytorch-call-to-action-links a[data-response='Run in Google Colab']").attr("href", colabLink);
	      $(".pytorch-call-to-action-links a[data-response='View on Github']").attr("href", githubLink);
	  }

          var overwrite = function(_) {
              if ($(this).length > 0) {
                  $(this)[0].href = "https://github.com/pytorch/rl"
              }
          }
          // PC
          $(".main-menu a:contains('GitHub')").each(overwrite);
          // Mobile
          $(".main-menu a:contains('Github')").each(overwrite);
      });

      
       $(window).ready(function() {
           var original = window.sideMenus.bind;
           var startup = true;
           window.sideMenus.bind = function() {
               original();
               if (startup) {
                   $("#pytorch-right-menu a.reference.internal").each(function(i) {
                       if (this.classList.contains("not-expanded")) {
                           this.nextElementSibling.style.display = "block";
                           this.classList.remove("not-expanded");
                           this.classList.add("expanded");
                       }
                   });
                   startup = false;
               }
           };
       });
    </script>

    


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="https://www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="https://www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
           <li class="resources-mobile-menu-title">
             <a>Learn</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/get-started">Get Started</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials">Tutorials</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/basics/intro.html">Learn the Basics</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/recipes/recipes_index.html">PyTorch Recipes</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/introyt.html">Introduction to PyTorch - YouTube Series</a>
             </li>
           </ul>
           <li class="resources-mobile-menu-title">
             <a>Ecosystem</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/ecosystem">Tools</a>
             </li>
             <li>
               <a href="https://pytorch.org/#community-module">Community</a>
             </li>
             <li>
               <a href="https://discuss.pytorch.org/">Forums</a>
             </li>
             <li>
               <a href="https://pytorch.org/resources">Developer Resources</a>
             </li>
             <li>
               <a href="https://pytorch.org/ecosystem/contributor-awards-2023">Contributor Awards - 2024</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>Edge</a>
           </li>

           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/edge">About PyTorch Edge</a>
             </li>
             
             <li>
               <a href="https://pytorch.org/executorch-overview">ExecuTorch</a>
             </li>
             <li>
               <a href="https://pytorch.org/executorch/stable/index.html">ExecuTorch Documentation</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>Docs</a>
           </li>

           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/pytorch-domains">PyTorch Domains</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            <a>Blog & News</a>
          </li>
            
           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/blog/">PyTorch Blog</a>
            </li>
            <li>
              <a href="https://pytorch.org/community-blog">Community Blog</a>
            </li>

            <li>
              <a href="https://pytorch.org/videos">Videos</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>
            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>
            <li>
               <a href="https://pytorch.org/newsletter">Newsletter</a>
             </li>
          </ul>
          
          <li class="resources-mobile-menu-title">
            <a>About</a>
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>
            <li>
              <a href="https://pytorch.org/governing-board">Governing Board</a>
            </li>
            <li>
               <a href="https://pytorch.org/credits">Cloud Credit Program</a>
            </li>
            <li>
               <a href="https://pytorch.org/tac">Technical Advisory Council</a>
            </li>
            <li>
               <a href="https://pytorch.org/staff">Staff</a>
            </li>
            <li>
               <a href="https://pytorch.org/contact-us">Contact Us</a>
            </li>
          </ul>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>