


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torchrl.envs.libs.gym &mdash; torchrl main documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sg_gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sg_gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sg_gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx-design.5ea377869091fd0449014c60fc090103.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','UA-117752657-2');</script>
    <!-- End Google Tag Manager -->
  

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Learn
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/get-started">
                  <span class=dropdown-title>Get Started</span>
                  <p>Run PyTorch locally or get started quickly with one of the supported cloud platforms</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials">
                  <span class="dropdown-title">Tutorials</span>
                  <p>Whats new in PyTorch tutorials</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/basics/intro.html">
                  <span class="dropdown-title">Learn the Basics</span>
                  <p>Familiarize yourself with PyTorch concepts and modules</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/recipes/recipes_index.html">
                  <span class="dropdown-title">PyTorch Recipes</span>
                  <p>Bite-size, ready-to-deploy PyTorch code examples</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/introyt.html">
                  <span class="dropdown-title">Intro to PyTorch - YouTube Series</span>
                  <p>Master PyTorch basics with our engaging YouTube tutorial series</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Ecosystem
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem">
                  <span class="dropdown-title">Tools</span>
                  <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class=dropdown-title>Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class=dropdown-title>Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem/contributor-awards-2024">
                  <span class="dropdown-title">Contributor Awards - 2024</span>
                  <p>Award winners announced at this year's PyTorch Conference</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/edge">
                  <span class="dropdown-title">About PyTorch Edge</span>
                  <p>Build innovative and privacy-aware AI experiences for edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/executorch-overview">
                  <span class="dropdown-title">ExecuTorch</span>
                  <p>End-to-end solution for enabling on-device inference capabilities across mobile and edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/executorch/stable/index.html">
                  <span class="dropdown-title">ExecuTorch Docs</span>
                </a>
              </div>
            </div>  
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p>Explore the documentation for comprehensive guidance on how to use PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/pytorch-domains">
                  <span class="dropdown-title">PyTorch Domains</span>
                  <p>Read the PyTorch Domains documentation to learn more about domain-specific libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Blogs & News 
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/blog/">
                  <span class="dropdown-title">PyTorch Blog</span>
                  <p>Catch up on the latest technical news and happenings</p>
                </a>
                 <a class="nav-dropdown-item" href="https://pytorch.org/community-blog">
                  <span class="dropdown-title">Community Blog</span>
                  <p>Stories from the PyTorch ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/videos">
                  <span class="dropdown-title">Videos</span>
                  <p>Learn about the latest PyTorch tutorials, new, and more </p>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/newsletter">
                  <span class="dropdown-title">Newsletter</span>
                  <p>Stay up-to-date with the latest updates</p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                About
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn more about the PyTorch Foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/governing-board">
                  <span class="dropdown-title">Governing Board</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/credits">
                  <span class="dropdown-title">Cloud Credit Program</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tac">
                  <span class="dropdown-title">Technical Advisory Council</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/staff">
                  <span class="dropdown-title">Staff</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/contact-us">
                  <span class="dropdown-title">Contact Us</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="https://pytorch.org/join" data-cta="join">
                Become a Member
              </a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later. 
          <li>
            <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href="../../../../../versions.html"><span style="font-size:110%">main (0.7.0+e0d3eee) &#x25BC</span></a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/getting-started-0.html">Get started with Environments, TED and transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/getting-started-1.html">Get started with TorchRLâ€™s modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/getting-started-2.html">Getting started with model optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/getting-started-3.html">Get started with data collection and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/getting-started-4.html">Get started with logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/getting-started-5.html">Get started with your own first training loop</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/coding_ppo.html">Reinforcement Learning (PPO) with TorchRL Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/pendulum.html">Pendulum: Writing your environment and transforms with TorchRL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/torchrl_demo.html">Introduction to TorchRL</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/multiagent_ppo.html">Multi-Agent Reinforcement Learning (PPO) with TorchRL Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/torchrl_envs.html">TorchRL envs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/pretrained_models.html">Using pretrained models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/dqn_with_rnn.html">Recurrent DQN: Training recurrent policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/rb_tutorial.html">Using Replay Buffers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/export.html">Exporting TorchRL modules</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/multiagent_competitive_ddpg.html">Competitive Multi-Agent Reinforcement Learning (DDPG) with TorchRL Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/multi_task.html">Task-specific policy in multi-task environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/coding_ddpg.html">TorchRL objectives: Coding a DDPG loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/coding_dqn.html">TorchRL trainer: A DQN example</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/index.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/knowledge_base.html">Knowledge Base</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../../index.html">Module code</a> &gt;</li>
        
      <li>torchrl.envs.libs.gym</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
    
    
          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=UA-117752657-2"
          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torchrl.envs.libs.gym</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Meta Platforms, Inc. and affiliates.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the MIT license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModuleType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">warnings</span><span class="w"> </span><span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">packaging</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tensordict</span><span class="w"> </span><span class="kn">import</span> <span class="n">TensorDict</span><span class="p">,</span> <span class="n">TensorDictBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils._pytree</span><span class="w"> </span><span class="kn">import</span> <span class="n">tree_map</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl._utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">implement_for</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.data.tensor_specs</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">_minmax_dtype</span><span class="p">,</span>
    <span class="n">Binary</span><span class="p">,</span>
    <span class="n">Bounded</span><span class="p">,</span>
    <span class="n">Categorical</span><span class="p">,</span>
    <span class="n">Composite</span><span class="p">,</span>
    <span class="n">MultiCategorical</span><span class="p">,</span>
    <span class="n">MultiOneHot</span><span class="p">,</span>
    <span class="n">NonTensor</span><span class="p">,</span>
    <span class="n">OneHot</span><span class="p">,</span>
    <span class="n">TensorSpec</span><span class="p">,</span>
    <span class="n">Unbounded</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.data.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">numpy_to_torch_dtype_dict</span><span class="p">,</span> <span class="n">torch_to_numpy_dtype_dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.envs.batched_envs</span><span class="w"> </span><span class="kn">import</span> <span class="n">CloudpickleWrapper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.envs.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">_EnvPostInit</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.envs.gym_like</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_info_dict_reader</span><span class="p">,</span> <span class="n">GymLikeEnv</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.envs.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_classproperty</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils._contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DecoratorContextManager</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">torchrl._utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DecoratorContextManager</span>

<span class="n">DEFAULT_GYM</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">IMPORT_ERROR</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1"># check gym presence without importing it</span>
<span class="n">_has_gym</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">_has_gym</span><span class="p">:</span>
    <span class="n">_has_gym</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="n">_has_mo</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;mo_gymnasium&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="n">_has_sb3</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;stable_baselines3&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="n">_has_minigrid</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;minigrid&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="n">GYMNASIUM_1_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;RuntimeError: TorchRL does not support gymnasium 1.0 or later versions due to incompatible</span>
<span class="s2">changes in the Gym API.</span>
<span class="s2">Using gymnasium 1.0 with TorchRL would require significant modifications to your code and may result in:</span>
<span class="s2">* Inaccurate step counting, as the auto-reset feature can cause unpredictable numbers of steps to be executed.</span>
<span class="s2">* Potential data corruption, as the environment may require/produce garbage data during reset steps.</span>
<span class="s2">* Trajectory overlap during data collection.</span>
<span class="s2">* Increased computational overhead, as the library would need to handle the additional complexity of auto-resets.</span>
<span class="s2">* Manual filtering and boilerplate code to mitigate these issues, which would compromise the modularity and ease of</span>
<span class="s2">use of TorchRL.</span>
<span class="s2">To maintain the integrity and efficiency of our library, we cannot support this version of gymnasium at this time.</span>
<span class="s2">If you need to use gymnasium 1.0 or later, we recommend exploring alternative solutions or waiting for future updates</span>
<span class="s2">to TorchRL and gymnasium that may address this compatibility issue.</span>
<span class="s2">For more information, please refer to discussion https://github.com/pytorch/rl/discussions/2483 in torchrl.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_minigrid_lib</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">_has_minigrid</span><span class="p">,</span> <span class="s2">&quot;minigrid not found&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">minigrid</span>

    <span class="k">return</span> <span class="n">minigrid</span>


<div class="viewcode-block" id="set_gym_backend"><a class="viewcode-back" href="../../../../reference/generated/torchrl.envs.set_gym_backend.html#torchrl.envs.set_gym_backend">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">set_gym_backend</span><span class="p">(</span><span class="n">_DecoratorContextManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets the gym-backend to a certain value.</span>

<span class="sd">    Args:</span>
<span class="sd">        backend (python module, string or callable returning a module): the</span>
<span class="sd">            gym backend to use. Use a string or callable whenever you wish to</span>
<span class="sd">            avoid importing gym at loading time.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import gym</span>
<span class="sd">        &gt;&gt;&gt; import gymnasium</span>
<span class="sd">        &gt;&gt;&gt; with set_gym_backend(&quot;gym&quot;):</span>
<span class="sd">        ...     assert gym_backend() == gym</span>
<span class="sd">        &gt;&gt;&gt; with set_gym_backend(lambda: gym):</span>
<span class="sd">        ...     assert gym_backend() == gym</span>
<span class="sd">        &gt;&gt;&gt; with set_gym_backend(gym):</span>
<span class="sd">        ...     assert gym_backend() == gym</span>
<span class="sd">        &gt;&gt;&gt; with set_gym_backend(&quot;gymnasium&quot;):</span>
<span class="sd">        ...     assert gym_backend() == gymnasium</span>
<span class="sd">        &gt;&gt;&gt; with set_gym_backend(lambda: gymnasium):</span>
<span class="sd">        ...     assert gym_backend() == gymnasium</span>
<span class="sd">        &gt;&gt;&gt; with set_gym_backend(gymnasium):</span>
<span class="sd">        ...     assert gym_backend() == gymnasium</span>

<span class="sd">    This class can also be used as a function decorator.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; @set_gym_backend(&quot;gym&quot;)</span>
<span class="sd">        ... def fun():</span>
<span class="sd">        ...     gym = gym_backend()</span>
<span class="sd">        ...     print(gym)</span>
<span class="sd">        &gt;&gt;&gt; fun()</span>
<span class="sd">        &lt;module &#39;gym&#39; from &#39;/path/to/env/site-packages/gym/__init__.py&#39;&gt;</span>
<span class="sd">        &gt;&gt;&gt; @set_gym_backend(&quot;gymnasium&quot;)</span>
<span class="sd">        ... def fun():</span>
<span class="sd">        ...     gym = gym_backend()</span>
<span class="sd">        ...     print(gym)</span>
<span class="sd">        &gt;&gt;&gt; fun()</span>
<span class="sd">        &lt;module &#39;gymnasium&#39; from &#39;/path/to/env/site-packages/gymnasium/__init__.py&#39;&gt;</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the backend as default.&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">DEFAULT_GYM</span>
        <span class="n">DEFAULT_GYM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span>
        <span class="n">found_setters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">setter</span> <span class="ow">in</span> <span class="n">copy</span><span class="p">(</span><span class="n">implement_for</span><span class="o">.</span><span class="n">_setters</span><span class="p">):</span>
            <span class="n">check_module</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">callable</span><span class="p">(</span><span class="n">setter</span><span class="o">.</span><span class="n">module_name</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">setter</span><span class="o">.</span><span class="n">module_name</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="n">setter</span><span class="o">.</span><span class="n">module_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">check_version</span> <span class="o">=</span> <span class="n">setter</span><span class="o">.</span><span class="n">check_version</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="n">setter</span><span class="o">.</span><span class="n">from_version</span><span class="p">,</span> <span class="n">setter</span><span class="o">.</span><span class="n">to_version</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">check_module</span> <span class="ow">and</span> <span class="n">check_version</span><span class="p">:</span>
                <span class="n">setter</span><span class="o">.</span><span class="n">module_set</span><span class="p">()</span>
                <span class="n">found_setter</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">check_module</span><span class="p">:</span>
                <span class="n">found_setter</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">found_setter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">found_setter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">found_setters</span><span class="p">[</span><span class="n">setter</span><span class="o">.</span><span class="n">func_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">found_setters</span><span class="p">[</span><span class="n">setter</span><span class="o">.</span><span class="n">func_name</span><span class="p">]</span> <span class="ow">or</span> <span class="n">found_setter</span>
                <span class="p">)</span>
        <span class="c1"># we keep only the setters we need. This is safe because a copy is saved under self._setters_saved</span>
        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">found_setter</span> <span class="ow">in</span> <span class="n">found_setters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_setter</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;could not set anything related to gym backend &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> with version=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2"> for the function with name </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Check that the gym versions match!&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Irreversibly sets the gym backend in the script.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># we save a complete list of setters as well as whether they should be set.</span>
        <span class="c1"># we want the full list becasue we want to be able to nest the calls to set_gym_backend.</span>
        <span class="c1"># we also want to keep track of which ones are set to reproduce what was set before.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setters_saved</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">implement_for</span><span class="o">.</span><span class="n">_implementations</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="n">implement_for</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">setters_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_setters_saved</span><span class="p">)</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_setters_saved&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># override this method if your children class takes __init__ parameters</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span>

    <span class="nd">@backend</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="gym_backend"><a class="viewcode-back" href="../../../../reference/generated/torchrl.envs.gym_backend.html#torchrl.envs.gym_backend">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">gym_backend</span><span class="p">(</span><span class="n">submodule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the gym backend, or a sumbodule of it.</span>

<span class="sd">    Args:</span>
<span class="sd">        submodule (str): the submodule to import. If ``None``, the backend</span>
<span class="sd">            itself is returned.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mo_gymnasium</span>
<span class="sd">        &gt;&gt;&gt; with set_gym_backend(&quot;gym&quot;):</span>
<span class="sd">        ...     wrappers = gym_backend(&#39;wrappers&#39;)</span>
<span class="sd">        ...     print(wrappers)</span>
<span class="sd">        &gt;&gt;&gt; with set_gym_backend(&quot;gymnasium&quot;):</span>
<span class="sd">        ...     wrappers = gym_backend(&#39;wrappers&#39;)</span>
<span class="sd">        ...     print(wrappers)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">IMPORT_ERROR</span>
    <span class="k">global</span> <span class="n">DEFAULT_GYM</span>
    <span class="k">if</span> <span class="n">DEFAULT_GYM</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># rule of thumbs: gymnasium precedes</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">gymnasium</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gym</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">IMPORT_ERROR</span> <span class="o">=</span> <span class="n">err</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">gym</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gym</span>
            <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">IMPORT_ERROR</span> <span class="o">=</span> <span class="n">err</span>
                <span class="n">gym</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">DEFAULT_GYM</span> <span class="o">=</span> <span class="n">gym</span>
    <span class="k">if</span> <span class="n">submodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">submodule</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
            <span class="n">submodule</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">submodule</span>
            <span class="n">submodule</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">submodule</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">DEFAULT_GYM</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">submodule</span>
    <span class="k">return</span> <span class="n">DEFAULT_GYM</span></div>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GymWrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;GymEnv&quot;</span><span class="p">]</span>


<span class="c1"># Define a dictionary to store conversion functions for each spec type</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_ConversionRegistry</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">UserDict</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># We want to find the closest parent</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">parents</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">space_cls</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;spaces&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">sbsp</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
                        <span class="n">space_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">space_cls</span><span class="p">,</span> <span class="n">sbsp</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="c1"># Some specs may be too recent</span>
                    <span class="k">continue</span>
                <span class="n">parents</span><span class="p">[</span><span class="n">space_cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">mro</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">mro</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">parents</span><span class="p">[</span><span class="n">p</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No conversion tool could be found with the gym space </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;You can register your own with `torchrl.envs.libs.register_gym_spec_conversion.`&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>


<span class="n">_conversion_registry</span> <span class="o">=</span> <span class="n">_ConversionRegistry</span><span class="p">()</span>


<div class="viewcode-block" id="register_gym_spec_conversion"><a class="viewcode-back" href="../../../../reference/generated/torchrl.envs.register_gym_spec_conversion.html#torchrl.envs.register_gym_spec_conversion">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">register_gym_spec_conversion</span><span class="p">(</span><span class="n">spec_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to register a conversion function for a specific spec type.</span>

<span class="sd">    The method must have the following signature:</span>

<span class="sd">        &gt;&gt;&gt; @register_gym_spec_conversion(&quot;spec.name&quot;)</span>
<span class="sd">        ... def convert_specname(</span>
<span class="sd">        ...     spec,</span>
<span class="sd">        ...     dtype=None,</span>
<span class="sd">        ...     device=None,</span>
<span class="sd">        ...     categorical_action_encoding=None,</span>
<span class="sd">        ...     remap_state_to_observation=None,</span>
<span class="sd">        ...     batch_size=None,</span>
<span class="sd">        ... ):</span>

<span class="sd">    where `gym(nasium).spaces.spec.name` is the location of the spec in gym.</span>

<span class="sd">    If the spec type is accessible, this will also work:</span>

<span class="sd">        &gt;&gt;&gt; @register_gym_spec_conversion(SpecType)</span>
<span class="sd">        ... def convert_specname(</span>
<span class="sd">        ...     spec,</span>
<span class="sd">        ...     dtype=None,</span>
<span class="sd">        ...     device=None,</span>
<span class="sd">        ...     categorical_action_encoding=None,</span>
<span class="sd">        ...     remap_state_to_observation=None,</span>
<span class="sd">        ...     batch_size=None,</span>
<span class="sd">        ... ):</span>

<span class="sd">    ..note:: The wrapped function can be simplified, and unused kwargs can be wrapped in `**kwargs`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">conversion_func</span><span class="p">):</span>
        <span class="n">_conversion_registry</span><span class="p">[</span><span class="n">spec_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_func</span>
        <span class="k">return</span> <span class="n">conversion_func</span>

    <span class="k">return</span> <span class="n">decorator</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_gym_to_torchrl_spec_transform</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maps the gym specs to the TorchRL specs.</span>

<span class="sd">    Args:</span>
<span class="sd">        spec (gym.spaces member): the gym space to transform.</span>
<span class="sd">        dtype (torch.dtype): a dtype to use for the spec.</span>
<span class="sd">            Defaults to`spec.dtype`.</span>
<span class="sd">        device (torch.device): the device for the spec.</span>
<span class="sd">            Defaults to ``None`` (no device for composite and default device for specs).</span>
<span class="sd">        categorical_action_encoding (bool): whether discrete spaces should be mapped to categorical or one-hot.</span>
<span class="sd">            Defaults to ``False`` (one-hot).</span>
<span class="sd">        remap_state_to_observation (bool): whether to rename the &#39;state&#39; key of</span>
<span class="sd">            Dict specs to &quot;observation&quot;. Default is true.</span>
<span class="sd">        batch_size (torch.Size): batch size to which expand the spec. Defaults to</span>
<span class="sd">            ``torch.Size([])``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">batch_size</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_gym_to_torchrl_spec_transform</span><span class="p">(</span>
            <span class="n">spec</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="n">categorical_action_encoding</span><span class="p">,</span>
            <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="n">remap_state_to_observation</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>

    <span class="c1"># Get the conversion function from the registry</span>
    <span class="n">conversion_func</span> <span class="o">=</span> <span class="n">_conversion_registry</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">spec</span><span class="p">)]</span>
    <span class="c1"># Call the conversion function with the provided arguments</span>
    <span class="k">return</span> <span class="n">conversion_func</span><span class="p">(</span>
        <span class="n">spec</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="n">categorical_action_encoding</span><span class="p">,</span>
        <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="n">remap_state_to_observation</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c1"># Register conversion functions for each spec type</span>
<span class="nd">@register_gym_spec_conversion</span><span class="p">(</span><span class="s2">&quot;tuple.Tuple&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_tuple_spec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Implementation for Tuple spec type</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">_gym_to_torchrl_spec_transform</span><span class="p">(</span>
                <span class="n">s</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="n">categorical_action_encoding</span><span class="p">,</span>
                <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="n">remap_state_to_observation</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec</span>
        <span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="nd">@register_gym_spec_conversion</span><span class="p">(</span><span class="s2">&quot;discrete.Discrete&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_discrete_spec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Implementation for Discrete spec type</span>
    <span class="n">action_space_cls</span> <span class="o">=</span> <span class="n">Categorical</span> <span class="k">if</span> <span class="n">categorical_action_encoding</span> <span class="k">else</span> <span class="n">OneHot</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">numpy_to_torch_dtype_dict</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">categorical_action_encoding</span>
        <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">long</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">action_space_cls</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>


<span class="nd">@register_gym_spec_conversion</span><span class="p">(</span><span class="s2">&quot;multi_binary.MultiBinary&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_multi_binary_spec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Implementation for MultiBinary spec type</span>
    <span class="k">return</span> <span class="n">Binary</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy_to_torch_dtype_dict</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">])</span>


<span class="nd">@register_gym_spec_conversion</span><span class="p">(</span><span class="s2">&quot;multi_discrete.MultiDiscrete&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_multidiscrete_spec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nvec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nvec</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">numpy_to_torch_dtype_dict</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">categorical_action_encoding</span>
            <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">long</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">MultiCategorical</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nvec</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">categorical_action_encoding</span>
            <span class="k">else</span> <span class="n">MultiOneHot</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nvec</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">_gym_to_torchrl_spec_transform</span><span class="p">(</span>
                <span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="n">categorical_action_encoding</span><span class="p">,</span>
                <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="n">remap_state_to_observation</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nvec</span><span class="p">))</span>
        <span class="p">],</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@register_gym_spec_conversion</span><span class="p">(</span><span class="s2">&quot;Box&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_box_spec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy_to_torch_dtype_dict</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">is_unbounded</span> <span class="o">=</span> <span class="n">low</span><span class="o">.</span><span class="n">isinf</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">high</span><span class="o">.</span><span class="n">isinf</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="n">_minmax_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">minval</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">minval</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">low</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">maxval</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">maxval</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">low</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">is_unbounded</span> <span class="o">=</span> <span class="n">is_unbounded</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">minval</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">maxval</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">Unbounded</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_unbounded</span>
        <span class="k">else</span> <span class="n">Bounded</span><span class="p">(</span>
            <span class="n">low</span><span class="p">,</span>
            <span class="n">high</span><span class="p">,</span>
            <span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="nd">@register_gym_spec_conversion</span><span class="p">(</span><span class="s2">&quot;Sequence&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_sequence_spec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">):</span>
        <span class="c1"># gym does not have a stack attribute in sequence</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;gymnasium should be used whenever a Sequence is present, as it needs to be stacked. &quot;</span>
            <span class="s2">&quot;If you need the gym backend at all price, please raise an issue on the TorchRL GitHub repository.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Sequence spaces must have the stack argument set to ``True``. &quot;</span>
        <span class="p">)</span>
    <span class="n">space</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">feature_space</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">_gym_to_torchrl_spec_transform</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">make_neg_dim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="nd">@register_gym_spec_conversion</span><span class="p">(</span><span class="n">Dict</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_dict_spec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">spec_out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">remap_state_to_observation</span>
            <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;state&quot;</span>
            <span class="ow">and</span> <span class="s2">&quot;observation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="c1"># we rename &quot;state&quot; in &quot;observation&quot; as &quot;observation&quot; is the conventional name</span>
            <span class="c1"># for single observation in torchrl.</span>
            <span class="c1"># naming it &#39;state&#39; will result in envs that have a different name for the state vector</span>
            <span class="c1"># when queried with and without pixels</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;observation&quot;</span>
        <span class="n">spec_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_gym_to_torchrl_spec_transform</span><span class="p">(</span>
            <span class="n">spec</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="n">categorical_action_encoding</span><span class="p">,</span>
            <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="n">remap_state_to_observation</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># the batch-size must be set later</span>
    <span class="k">return</span> <span class="n">Composite</span><span class="p">(</span><span class="n">spec_out</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>


<span class="nd">@register_gym_spec_conversion</span><span class="p">(</span><span class="s2">&quot;Text&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_text_soec</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="n">NonTensor</span><span class="p">((),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">example_data</span><span class="o">=</span><span class="s2">&quot;a string&quot;</span><span class="p">)</span>


<span class="nd">@register_gym_spec_conversion</span><span class="p">(</span><span class="s2">&quot;dict.Dict&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_dict_spec2</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="n">_gym_to_torchrl_spec_transform</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">spaces</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="n">categorical_action_encoding</span><span class="p">,</span>
        <span class="n">remap_state_to_observation</span><span class="o">=</span><span class="n">remap_state_to_observation</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.18&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_box_convert</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">gym_spaces</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.18&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_box_convert</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">gym_spaces</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_box_convert</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">gym_spaces</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_box_convert</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">gym_spaces</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">GYMNASIUM_1_ERROR</span><span class="p">)</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.21&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_multidiscrete_convert</span><span class="p">(</span><span class="n">gym_spaces</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">multi_discrete</span><span class="o">.</span><span class="n">MultiDiscrete</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">nvec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch_to_numpy_dtype_dict</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>
    <span class="p">)</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_multidiscrete_convert</span><span class="p">(</span><span class="n">gym_spaces</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
    <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">multi_discrete</span><span class="o">.</span><span class="n">MultiDiscrete</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">nvec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch_to_numpy_dtype_dict</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>
    <span class="p">)</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_multidiscrete_convert</span><span class="p">(</span><span class="n">gym_spaces</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">GYMNASIUM_1_ERROR</span><span class="p">)</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.21&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_multidiscrete_convert</span><span class="p">(</span><span class="n">gym_spaces</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
    <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">multi_discrete</span><span class="o">.</span><span class="n">MultiDiscrete</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nvec</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_torchrl_to_gym_spec_transform</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span>
    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maps TorchRL specs to gym spaces.</span>

<span class="sd">    Args:</span>
<span class="sd">        spec: the torchrl spec to transform.</span>
<span class="sd">        categorical_action_encoding: whether discrete spaces should be mapped to categorical or one-hot.</span>
<span class="sd">            Defaults to one-hot.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gym_spaces</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;spaces&quot;</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="n">_torchrl_to_gym_spec_transform</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span> <span class="n">stack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">Tuple</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">_torchrl_to_gym_spec_transform</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">MultiCategorical</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_multidiscrete_convert</span><span class="p">(</span><span class="n">gym_spaces</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">MultiOneHot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">multi_discrete</span><span class="o">.</span><span class="n">MultiDiscrete</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nvec</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">Binary</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">multi_binary</span><span class="o">.</span><span class="n">MultiBinary</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">Categorical</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">discrete</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">n</span>
        <span class="p">)</span>  <span class="c1"># dtype=torch_to_numpy_dtype_dict[spec.dtype])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">OneHot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">discrete</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">Unbounded</span><span class="p">):</span>
        <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="n">_minmax_dtype</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
            <span class="n">low</span><span class="o">=</span><span class="n">minval</span><span class="p">,</span>
            <span class="n">high</span><span class="o">=</span><span class="n">maxval</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">torch_to_numpy_dtype_dict</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">Unbounded</span><span class="p">):</span>
        <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="n">_minmax_dtype</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
            <span class="n">low</span><span class="o">=</span><span class="n">minval</span><span class="p">,</span>
            <span class="n">high</span><span class="o">=</span><span class="n">maxval</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">torch_to_numpy_dtype_dict</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">Bounded</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_box_convert</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">gym_spaces</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">Composite</span><span class="p">):</span>
        <span class="c1"># remove batch size</span>
        <span class="k">while</span> <span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">gym_spaces</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">_torchrl_to_gym_spec_transform</span><span class="p">(</span>
                    <span class="n">val</span><span class="p">,</span>
                    <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="n">categorical_action_encoding</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;spec of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is currently unaccounted for&quot;</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_envs</span><span class="p">(</span><span class="n">to_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_gym</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Gym(nasium) could not be found in your virtual environment.&quot;</span><span class="p">)</span>
    <span class="n">envs</span> <span class="o">=</span> <span class="n">_get_gym_envs</span><span class="p">()</span>
    <span class="n">envs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">envs</span><span class="p">)</span>
    <span class="n">envs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">envs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">envs</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.26.0&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_gym_envs</span><span class="p">():</span>  <span class="c1"># noqa: F811</span>
    <span class="n">gym</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gym</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">env_specs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.26.0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_gym_envs</span><span class="p">():</span>  <span class="c1"># noqa: F811</span>
    <span class="n">gym</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gym</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_gym_envs</span><span class="p">():</span>  <span class="c1"># noqa: F811</span>
    <span class="n">gym</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gym</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_gym_envs</span><span class="p">():</span>  <span class="c1"># noqa: F811</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">GYMNASIUM_1_ERROR</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_from_pixels</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="n">observation_spec</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">observation_space</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">PixelObservationWrapper</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span>
            <span class="s2">&quot;wrappers.pixel_observation&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">PixelObservationWrapper</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">PixelObservationWrapper</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.envs.libs.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">GymPixelObservationWrapper</span> <span class="k">as</span> <span class="n">LegacyPixelObservationWrapper</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">gDict</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;spaces&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">Dict</span>
    <span class="n">Box</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;spaces&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Box</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observation_spec</span><span class="p">,</span> <span class="p">(</span><span class="n">Dict</span><span class="p">,)):</span>
        <span class="k">if</span> <span class="s2">&quot;pixels&quot;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">observation_spec</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observation_spec</span><span class="p">,</span> <span class="p">(</span><span class="n">gDict</span><span class="p">,)):</span>
        <span class="k">if</span> <span class="s2">&quot;pixels&quot;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">observation_spec</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">observation_spec</span><span class="p">,</span> <span class="n">Box</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">observation_spec</span><span class="o">.</span><span class="n">low</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">observation_spec</span><span class="o">.</span><span class="n">high</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="ow">and</span> <span class="n">observation_spec</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="ow">and</span> <span class="n">observation_spec</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span> <span class="p">(</span><span class="n">LegacyPixelObservationWrapper</span><span class="p">,</span> <span class="n">PixelObservationWrapper</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">):</span>
                <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">env</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_GymAsyncMeta</span><span class="p">(</span><span class="n">_EnvPostInit</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">instance</span><span class="p">:</span> <span class="n">GymWrapper</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># before gym 0.22, there was no final_observation</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">_is_batched</span><span class="p">:</span>
            <span class="n">gym_backend</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_library_name</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.envs.transforms.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">TransformedEnv</span><span class="p">,</span>
                <span class="n">VecGymEnvTransform</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">_has_sb3</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">stable_baselines3.common.vec_env.base_vec_env</span><span class="w"> </span><span class="kn">import</span> <span class="n">VecEnv</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_env</span><span class="p">,</span> <span class="n">VecEnv</span><span class="p">):</span>
                    <span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;sb3&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;gym&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;gym&quot;</span>

            <span class="c1"># we need 3 checks: the backend is not sb3 (if so, gymnasium is used),</span>
            <span class="c1"># it is gym and not gymnasium and the version is before 0.22.0</span>
            <span class="n">add_info_dict</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;gym&quot;</span> <span class="ow">and</span> <span class="n">gym_backend</span> <span class="o">==</span> <span class="s2">&quot;gym&quot;</span><span class="p">:</span>  <span class="c1"># check gym against gymnasium</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">gym</span>

                <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">gym</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;0.22.0&quot;</span><span class="p">):</span>
                    <span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;A batched gym environment is being wrapped in a GymWrapper with gym version &lt; 0.22. &quot;</span>
                        <span class="s2">&quot;This implies that the next-observation is wrongly tracked (as the batched environment auto-resets &quot;</span>
                        <span class="s2">&quot;and discards the true next observation to return the result of the step). &quot;</span>
                        <span class="s2">&quot;This isn&#39;t compatible with TorchRL API and should be used with caution.&quot;</span><span class="p">,</span>
                        <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">add_info_dict</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">add_info_dict</span><span class="p">:</span>
                <span class="c1"># register terminal_obs_reader</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">auto_register_info_dict</span><span class="p">(</span>
                    <span class="n">info_dict_reader</span><span class="o">=</span><span class="n">terminal_obs_reader</span><span class="p">(</span>
                        <span class="n">instance</span><span class="o">.</span><span class="n">observation_spec</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">TransformedEnv</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">VecGymEnvTransform</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">instance</span>


<div class="viewcode-block" id="GymWrapper"><a class="viewcode-back" href="../../../../reference/generated/torchrl.envs.GymWrapper.html#torchrl.envs.GymWrapper">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">GymWrapper</span><span class="p">(</span><span class="n">GymLikeEnv</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">_GymAsyncMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenAI Gym environment wrapper.</span>

<span class="sd">    Works accross `gymnasium &lt;https://gymnasium.farama.org/&gt;`_ and `OpenAI/gym &lt;https://github.com/openai/gym&gt;`_.</span>

<span class="sd">    Args:</span>
<span class="sd">        env (gym.Env): the environment to wrap. Batched environments (:class:`~stable_baselines3.common.vec_env.base_vec_env.VecEnv`</span>
<span class="sd">            or :class:`gym.VectorEnv`) are supported and the environment batch-size</span>
<span class="sd">            will reflect the number of environments executed in parallel.</span>
<span class="sd">        categorical_action_encoding (bool, optional): if ``True``, categorical</span>
<span class="sd">            specs will be converted to the TorchRL equivalent (:class:`torchrl.data.Categorical`),</span>
<span class="sd">            otherwise a one-hot encoding will be used (:class:`torchrl.data.OneHot`).</span>
<span class="sd">            Defaults to ``False``.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        from_pixels (bool, optional): if ``True``, an attempt to return the pixel</span>
<span class="sd">            observations from the env will be performed. By default, these observations</span>
<span class="sd">            will be written under the ``&quot;pixels&quot;`` entry.</span>
<span class="sd">            The method being used varies</span>
<span class="sd">            depending on the gym version and may involve a ``wrappers.pixel_observation.PixelObservationWrapper``.</span>
<span class="sd">            Defaults to ``False``.</span>
<span class="sd">        pixels_only (bool, optional): if ``True``, only the pixel observations will</span>
<span class="sd">            be returned (by default under the ``&quot;pixels&quot;`` entry in the output tensordict).</span>
<span class="sd">            If ``False``, observations (eg, states) and pixels will be returned</span>
<span class="sd">            whenever ``from_pixels=True``. Defaults to ``True``.</span>
<span class="sd">        frame_skip (int, optional): if provided, indicates for how many steps the</span>
<span class="sd">            same action is to be repeated. The observation returned will be the</span>
<span class="sd">            last observation of the sequence, whereas the reward will be the sum</span>
<span class="sd">            of rewards across steps.</span>
<span class="sd">        device (torch.device, optional): if provided, the device on which the data</span>
<span class="sd">            is to be cast. Defaults to ``torch.device(&quot;cpu&quot;)``.</span>
<span class="sd">        batch_size (torch.Size, optional): the batch size of the environment.</span>
<span class="sd">            Should match the leading dimensions of all observations, done states,</span>
<span class="sd">            rewards, actions and infos.</span>
<span class="sd">            Defaults to ``torch.Size([])``.</span>
<span class="sd">        allow_done_after_reset (bool, optional): if ``True``, it is tolerated</span>
<span class="sd">            for envs to be ``done`` just after :meth:`reset` is called.</span>
<span class="sd">            Defaults to ``False``.</span>
<span class="sd">        convert_actions_to_numpy (bool, optional): if ``True``, actions will be</span>
<span class="sd">            converted from tensors to numpy arrays and moved to CPU before being passed to the</span>
<span class="sd">            env step function. Set this to ``False`` if the environment is evaluated</span>
<span class="sd">            on GPU, such as IsaacLab.</span>
<span class="sd">            Defaults to ``True``.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        available_envs (List[str]): a list of environments to build.</span>

<span class="sd">    .. note::</span>
<span class="sd">        If an attribute cannot be found, this class will attempt to retrieve it from</span>
<span class="sd">        the nested env:</span>

<span class="sd">            &gt;&gt;&gt; from torchrl.envs import GymWrapper</span>
<span class="sd">            &gt;&gt;&gt; import gymnasium as gym</span>
<span class="sd">            &gt;&gt;&gt; env = GymWrapper(gym.make(&quot;Pendulum-v1&quot;))</span>
<span class="sd">            &gt;&gt;&gt; print(env.spec.max_episode_steps)</span>
<span class="sd">            200</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import gymnasium as gym</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs import GymWrapper</span>
<span class="sd">        &gt;&gt;&gt; base_env = gym.make(&quot;Pendulum-v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; env = GymWrapper(base_env)</span>
<span class="sd">        &gt;&gt;&gt; td = env.rand_step()</span>
<span class="sd">        &gt;&gt;&gt; print(td)</span>
<span class="sd">        TensorDict(</span>
<span class="sd">            fields={</span>
<span class="sd">                action: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.float32, is_shared=False),</span>
<span class="sd">                next: TensorDict(</span>
<span class="sd">                    fields={</span>
<span class="sd">                        done: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.bool, is_shared=False),</span>
<span class="sd">                        observation: Tensor(shape=torch.Size([3]), device=cpu, dtype=torch.float32, is_shared=False),</span>
<span class="sd">                        reward: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.float32, is_shared=False),</span>
<span class="sd">                        terminated: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.bool, is_shared=False),</span>
<span class="sd">                        truncated: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.bool, is_shared=False)},</span>
<span class="sd">                    batch_size=torch.Size([]),</span>
<span class="sd">                    device=cpu,</span>
<span class="sd">                    is_shared=False)},</span>
<span class="sd">            batch_size=torch.Size([]),</span>
<span class="sd">            device=cpu,</span>
<span class="sd">            is_shared=False)</span>
<span class="sd">        &gt;&gt;&gt; print(env.available_envs)</span>
<span class="sd">        [&#39;ALE/Adventure-ram-v5&#39;, &#39;ALE/Adventure-v5&#39;, &#39;ALE/AirRaid-ram-v5&#39;, &#39;ALE/AirRaid-v5&#39;, &#39;ALE/Alien-ram-v5&#39;, &#39;ALE/Alien-v5&#39;,</span>

<span class="sd">    .. note::</span>
<span class="sd">        info dictionaries will be read using :class:`~torchrl.envs.gym_like.default_info_dict_reader`</span>
<span class="sd">        if no other reader is provided. To provide another reader, refer to</span>
<span class="sd">        :meth:`set_info_dict_reader`. To automatically register the info_dict</span>
<span class="sd">        content, refer to :meth:`torchrl.envs.GymLikeEnv.auto_register_info_dict`.</span>
<span class="sd">        For parallel (Vectorized) environments, the info dictionary reader is automatically set and should</span>
<span class="sd">        not be set manually.</span>

<span class="sd">    .. note:: Gym spaces are not completely covered.</span>
<span class="sd">        The following spaces are accounted for provided that they can be represented by a torch.Tensor, a nested tensor</span>
<span class="sd">        and/or within a tensordict:</span>

<span class="sd">        - spaces.Box</span>
<span class="sd">        - spaces.Sequence</span>
<span class="sd">        - spaces.Tuple</span>
<span class="sd">        - spaces.Discrete</span>
<span class="sd">        - spaces.MultiBinary</span>
<span class="sd">        - spaces.MultiDiscrete</span>
<span class="sd">        - spaces.Dict</span>

<span class="sd">        Some considerations should be made when working with gym spaces. For instance, a tuple of spaces</span>
<span class="sd">        can only be supported if the spaces are semantically identical (same dtype and same number of dimensions).</span>
<span class="sd">        Ragged dimension can be supported through :func:`~torch.nested.nested_tensor`, but then there should be only</span>
<span class="sd">        one level of tuple and data should be stacked along the first dimension (as nested_tensors can only be</span>
<span class="sd">        stacked along the first dimension).</span>

<span class="sd">        Check the example in examples/envs/gym_conversion_examples.py to know more!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">git_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/openai/gym&quot;</span>
    <span class="n">libname</span> <span class="o">=</span> <span class="s2">&quot;gym&quot;</span>

    <span class="nd">@_classproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">available_envs</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_gym</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">_get_envs</span><span class="p">())</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_library_name</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a gym environment, returns the backend name (either gym or gymnasium).</span>

<span class="sd">        This can be used to set the appropriate backend when needed:</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; env = gymnasium.make(&quot;Pendulum-v1&quot;)</span>
<span class="sd">            &gt;&gt;&gt; with set_gym_backend(env):</span>
<span class="sd">            ...    env = GymWrapper(env)</span>

<span class="sd">        :class:`~GymWrapper` and similar use this method to set their method</span>
<span class="sd">        to the right backend during instantiation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">gym</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span> <span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">Space</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;gym&quot;</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">gymnasium</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span> <span class="n">gymnasium</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">Space</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;gymnasium&quot;</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not find the library of env </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">. Please file an issue on torchrl github repo.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seed_calls_reset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_categorical_action_encoding</span> <span class="o">=</span> <span class="n">categorical_action_encoding</span>
        <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">env_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># MiniGrid has a bug where the __str__ method fails</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;EnvCompatibility&quot;</span> <span class="ow">in</span> <span class="n">env_str</span>
                <span class="p">):</span>  <span class="c1"># a hacky way of knowing if EnvCompatibility is part of the wrappers of env</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;GymWrapper does not support the gym.wrapper.compatibility.EnvCompatibility wrapper. &quot;</span>
                        <span class="s2">&quot;If this feature is needed, detail your use case in an issue of &quot;</span>
                        <span class="s2">&quot;https://github.com/pytorch/rl/issues.&quot;</span>
                    <span class="p">)</span>
            <span class="n">libname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_library_name</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">set_gym_backend</span><span class="p">(</span><span class="n">libname</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post_init</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># writes the functions that are gym-version specific to the instance</span>
        <span class="c1"># once and for all. This is aimed at avoiding the need of decorating code</span>
        <span class="c1"># with set_gym_backend + allowing for parallel execution (which would</span>
        <span class="c1"># be troublesome when both an old version of gym and recent gymnasium</span>
        <span class="c1"># are present within the same virtual env).</span>
        <span class="c1">#</span>
        <span class="c1"># These calls seemingly do nothing but they actually get rid of the @implement_for decorator.</span>
        <span class="c1"># We execute them within the set_gym_backend context manager to make sure we get</span>
        <span class="c1"># the right implementation.</span>
        <span class="c1">#</span>
        <span class="c1"># This method is executed by the metaclass of GymWrapper.</span>
        <span class="k">with</span> <span class="n">set_gym_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_library_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_output_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_output_transform</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_transform</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_batched</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_has_sb3</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">stable_baselines3.common.vec_env.base_vec_env</span><span class="w"> </span><span class="kn">import</span> <span class="n">VecEnv</span>

            <span class="n">tuple_of_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">VecEnv</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tuple_of_classes</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">,</span> <span class="n">tuple_of_classes</span> <span class="o">+</span> <span class="p">(</span><span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;vector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">VectorEnv</span><span class="p">,)</span>
        <span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_batch_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;num_envs&quot;</span><span class="p">):</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">env</span><span class="o">.</span><span class="n">num_envs</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">return</span> <span class="n">batch_size</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>  <span class="c1"># gymnasium wants the unwrapped env</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_batch_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="n">env_unwrapped</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">unwrapped</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env_unwrapped</span><span class="p">,</span> <span class="s2">&quot;num_envs&quot;</span><span class="p">):</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">env_unwrapped</span><span class="o">.</span><span class="n">num_envs</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">return</span> <span class="n">batch_size</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_batch_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">GYMNASIUM_1_ERROR</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;env&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Could not find environment key &#39;env&#39; in kwargs.&quot;</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;action_space&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;observation_space&quot;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;env is not of type &#39;gym.Env&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_env</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">,</span>
        <span class="n">from_pixels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">pixels_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;gym.core.Env&quot;</span><span class="p">:</span>  <span class="c1"># noqa: F821</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_batch_size</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

        <span class="n">env_from_pixels</span> <span class="o">=</span> <span class="n">_is_from_pixels</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="n">from_pixels</span> <span class="o">=</span> <span class="n">from_pixels</span> <span class="ow">or</span> <span class="n">env_from_pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_pixels</span> <span class="o">=</span> <span class="n">from_pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixels_only</span> <span class="o">=</span> <span class="n">pixels_only</span>
        <span class="k">if</span> <span class="n">from_pixels</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env_from_pixels</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">PixelObservationWrapper</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span>
                    <span class="s2">&quot;wrappers.pixel_observation.PixelObservationWrapper&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">PixelObservationWrapper</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;PixelObservationWrapper cannot be used to wrap an environment &quot;</span>
                        <span class="s2">&quot;that is already a PixelObservationWrapper instance.&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_gym_env</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">env</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="n">action</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_spec</span><span class="p">,</span> <span class="p">(</span><span class="n">OneHot</span><span class="p">,</span> <span class="n">Categorical</span><span class="p">))</span> <span class="ow">and</span> <span class="n">action</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># some envs require an integer for indexing</span>
            <span class="n">action</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">action</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.19.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_gym_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">GymPixelObservationWrapper</span> <span class="k">as</span> <span class="n">PixelObservationWrapper</span>

        <span class="k">return</span> <span class="n">PixelObservationWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="o">=</span><span class="n">pixels_only</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.19.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.26.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_gym_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="n">pixel_observation</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;wrappers.pixel_observation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pixel_observation</span><span class="o">.</span><span class="n">PixelObservationWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="o">=</span><span class="n">pixels_only</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.26.0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_gym_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="n">compatibility</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;wrappers.compatibility&quot;</span><span class="p">)</span>
        <span class="n">pixel_observation</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;wrappers.pixel_observation&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">render_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pixel_observation</span><span class="o">.</span><span class="n">PixelObservationWrapper</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="o">=</span><span class="n">pixels_only</span>
            <span class="p">)</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Environments provided to GymWrapper that need to be wrapped in PixelObservationWrapper &quot;</span>
            <span class="s2">&quot;should be created with `gym.make(env_name, render_mode=mode)` where possible,&quot;</span>
            <span class="s1">&#39;where mode is either &quot;rgb_array&quot; or any other supported mode.&#39;</span>
        <span class="p">)</span>
        <span class="c1"># resetting as 0.26 comes with a very &#39;nice&#39; OrderEnforcing wrapper</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">compatibility</span><span class="o">.</span><span class="n">EnvCompatibility</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.envs.libs.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">GymPixelObservationWrapper</span> <span class="k">as</span> <span class="n">LegacyPixelObservationWrapper</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">LegacyPixelObservationWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="o">=</span><span class="n">pixels_only</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_gym_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">GYMNASIUM_1_ERROR</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_gym_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="n">compatibility</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;wrappers.compatibility&quot;</span><span class="p">)</span>
        <span class="n">pixel_observation</span> <span class="o">=</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;wrappers.pixel_observation&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">render_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pixel_observation</span><span class="o">.</span><span class="n">PixelObservationWrapper</span><span class="p">(</span>
                <span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="o">=</span><span class="n">pixels_only</span>
            <span class="p">)</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Environments provided to GymWrapper that need to be wrapped in PixelObservationWrapper &quot;</span>
            <span class="s2">&quot;should be created with `gym.make(env_name, render_mode=mode)` where possible,&quot;</span>
            <span class="s1">&#39;where mode is either &quot;rgb_array&quot; or any other supported mode.&#39;</span>
        <span class="p">)</span>
        <span class="c1"># resetting as 0.26 comes with a very &#39;nice&#39; OrderEnforcing wrapper</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">compatibility</span><span class="o">.</span><span class="n">EnvCompatibility</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">torchrl.envs.libs.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">GymPixelObservationWrapper</span> <span class="k">as</span> <span class="n">LegacyPixelObservationWrapper</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">LegacyPixelObservationWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="o">=</span><span class="n">pixels_only</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lib</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModuleType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gym_backend</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seed_calls_reset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Determine basing on gym version whether `reset` is called when setting seed.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_seed_initial</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seed_calls_reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">seed</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.15.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_seed_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seed_calls_reset</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.15.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.19.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_seed_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seed_calls_reset</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.19.0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_seed_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seed_calls_reset</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;reset with seed kwarg returned an exception: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Calling env.seed from now on.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seed_calls_reset</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err2</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_seed_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">GYMNASIUM_1_ERROR</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_seed_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seed_calls_reset</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;reset with seed kwarg returned an exception: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Calling env.seed from now on.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seed_calls_reset</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_reward_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;reward_space&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">env</span><span class="o">.</span><span class="n">reward_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">reward_space</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_reward_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">GYMNASIUM_1_ERROR</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_reward_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">unwrapped</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;reward_space&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">env</span><span class="o">.</span><span class="n">reward_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reward_space</span>
            <span class="k">return</span> <span class="n">rs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="s2">&quot;gym.Env&quot;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F821</span>
        <span class="c1"># If batch_size is provided, we se it to tell what batch size must be used</span>
        <span class="c1"># instead of self.batch_size</span>
        <span class="n">cur_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([])</span>
        <span class="n">action_spec</span> <span class="o">=</span> <span class="n">_gym_to_torchrl_spec_transform</span><span class="p">(</span>
            <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_categorical_action_encoding</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">observation_spec</span> <span class="o">=</span> <span class="n">_gym_to_torchrl_spec_transform</span><span class="p">(</span>
            <span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_categorical_action_encoding</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observation_spec</span><span class="p">,</span> <span class="n">Composite</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_pixels</span><span class="p">:</span>
                <span class="n">observation_spec</span> <span class="o">=</span> <span class="n">Composite</span><span class="p">(</span>
                    <span class="n">pixels</span><span class="o">=</span><span class="n">observation_spec</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">cur_batch_size</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">observation_spec</span> <span class="o">=</span> <span class="n">Composite</span><span class="p">(</span>
                    <span class="n">observation</span><span class="o">=</span><span class="n">observation_spec</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">cur_batch_size</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">observation_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_batch_size</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">cur_batch_size</span><span class="p">:</span>
            <span class="n">observation_spec</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">cur_batch_size</span>

        <span class="n">reward_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reward_space</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reward_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reward_spec</span> <span class="o">=</span> <span class="n">_gym_to_torchrl_spec_transform</span><span class="p">(</span>
                <span class="n">reward_space</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="n">categorical_action_encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_categorical_action_encoding</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reward_spec</span> <span class="o">=</span> <span class="n">Unbounded</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">action_spec</span> <span class="o">=</span> <span class="n">action_spec</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">*</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">*</span><span class="n">action_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">reward_spec</span> <span class="o">=</span> <span class="n">reward_spec</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">*</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">*</span><span class="n">reward_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">observation_spec</span> <span class="o">=</span> <span class="n">observation_spec</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                <span class="o">*</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">*</span><span class="n">observation_spec</span><span class="o">.</span><span class="n">shape</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">done_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_done_spec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_spec</span> <span class="o">=</span> <span class="n">action_spec</span>
        <span class="k">if</span> <span class="n">reward_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_batch_size</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">cur_batch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reward_spec</span> <span class="o">=</span> <span class="n">reward_spec</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">*</span><span class="n">cur_batch_size</span><span class="p">,</span> <span class="o">*</span><span class="n">reward_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reward_spec</span> <span class="o">=</span> <span class="n">reward_spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation_spec</span> <span class="o">=</span> <span class="n">observation_spec</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.26&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_done_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="k">return</span> <span class="n">Composite</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;done&quot;</span><span class="p">:</span> <span class="n">Categorical</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;terminated&quot;</span><span class="p">:</span> <span class="n">Categorical</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;truncated&quot;</span><span class="p">:</span> <span class="n">Categorical</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">},</span>
            <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.26&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_done_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="k">return</span> <span class="n">Composite</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;done&quot;</span><span class="p">:</span> <span class="n">Categorical</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;terminated&quot;</span><span class="p">:</span> <span class="n">Categorical</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;truncated&quot;</span><span class="p">:</span> <span class="n">Categorical</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">},</span>
            <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;0.27&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_done_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="k">return</span> <span class="n">Composite</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;done&quot;</span><span class="p">:</span> <span class="n">Categorical</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;terminated&quot;</span><span class="p">:</span> <span class="n">Categorical</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;truncated&quot;</span><span class="p">:</span> <span class="n">Categorical</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">},</span>
            <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.26&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_output_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_data</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">reset_data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reset_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reset_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">reset_data</span>
        <span class="k">return</span> <span class="n">reset_data</span><span class="p">,</span> <span class="kc">None</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.26&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_output_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_data</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="k">return</span> <span class="n">reset_data</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;0.27&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_output_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_data</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="k">return</span> <span class="n">reset_data</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.24&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_output_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_outputs_tuple</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="n">observations</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">step_outputs_tuple</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_batched</span><span class="p">:</span>
            <span class="c1"># info needs to be flipped</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">_flip_info_tuple</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="c1"># The variable naming follows torchrl&#39;s convention here.</span>
        <span class="c1"># A done is interpreted the union of terminated and truncated.</span>
        <span class="c1"># (as in earlier versions of gym).</span>
        <span class="n">truncated</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;TimeLimit.truncated&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">truncated</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="c1"># if bool is an array, make truncated an array</span>
            <span class="n">truncated</span> <span class="o">=</span> <span class="p">[</span><span class="n">truncated</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
            <span class="n">truncated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">truncated</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">truncated</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="c1"># make sure it&#39;s a boolean np.array</span>
            <span class="n">truncated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">truncated</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">))</span>
        <span class="n">terminated</span> <span class="o">=</span> <span class="n">done</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">truncated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">terminated</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># if it&#39;s not a ndarray, we must return bool</span>
            <span class="c1"># since it&#39;s not a bool, we make it so</span>
            <span class="n">terminated</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">terminated</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Until gym 0.25.2 we had rendered frames returned in lists of length 1</span>
            <span class="n">observations</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.24&quot;</span><span class="p">,</span> <span class="s2">&quot;0.26&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_output_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_outputs_tuple</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="n">observations</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">step_outputs_tuple</span>
        <span class="c1"># The variable naming follows torchrl&#39;s convention here.</span>
        <span class="c1"># A done is interpreted the union of terminated and truncated.</span>
        <span class="c1"># (as in earlier versions of gym).</span>
        <span class="n">truncated</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;TimeLimit.truncated&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">truncated</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="c1"># if bool is an array, make truncated an array</span>
            <span class="n">truncated</span> <span class="o">=</span> <span class="p">[</span><span class="n">truncated</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
            <span class="n">truncated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">truncated</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">truncated</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="c1"># make sure it&#39;s a boolean np.array</span>
            <span class="n">truncated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">truncated</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">))</span>
        <span class="n">terminated</span> <span class="o">=</span> <span class="n">done</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">truncated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">terminated</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># if it&#39;s not a ndarray, we must return bool</span>
            <span class="c1"># since it&#39;s not a bool, we make it so</span>
            <span class="n">terminated</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">terminated</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Until gym 0.25.2 we had rendered frames returned in lists of length 1</span>
            <span class="n">observations</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.26&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_output_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_outputs_tuple</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="c1"># The variable naming follows torchrl&#39;s convention here.</span>
        <span class="n">observations</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">step_outputs_tuple</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">observations</span><span class="p">,</span>
            <span class="n">reward</span><span class="p">,</span>
            <span class="n">terminated</span><span class="p">,</span>
            <span class="n">truncated</span><span class="p">,</span>
            <span class="n">terminated</span> <span class="o">|</span> <span class="n">truncated</span><span class="p">,</span>
            <span class="n">info</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;0.27&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_output_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_outputs_tuple</span><span class="p">):</span>  <span class="c1"># noqa: F811</span>
        <span class="c1"># The variable naming follows torchrl&#39;s convention here.</span>
        <span class="n">observations</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">step_outputs_tuple</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">observations</span><span class="p">,</span>
            <span class="n">reward</span><span class="p">,</span>
            <span class="n">terminated</span><span class="p">,</span>
            <span class="n">truncated</span><span class="p">,</span>
            <span class="n">terminated</span> <span class="o">|</span> <span class="n">truncated</span><span class="p">,</span>
            <span class="n">info</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="c1"># init_reset = self.init_reset</span>
        <span class="c1"># if init_reset is None:</span>
        <span class="c1">#     warnings.warn(f&quot;init_env is None in the {type(self).__name__} constructor. The current &quot;</span>
        <span class="c1">#                   f&quot;default behavior is to reset the gym env as soon as it&#39;s wrapped in the &quot;</span>
        <span class="c1">#                   f&quot;class (init_reset=True), but from v0.9 this will be changed to False. &quot;</span>
        <span class="c1">#                   f&quot;To adapt for these changes, pass init_reset to your constructor.&quot;, category=FutureWarning)</span>
        <span class="c1">#     init_reset = True</span>
        <span class="c1"># if init_reset:</span>
        <span class="c1">#     self._env.reset()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(env=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="si">}</span><span class="s2">, batch_size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rebuild_with_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">new_kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructor_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_env</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_constructor_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_specs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tensordict</span><span class="p">:</span> <span class="n">TensorDictBase</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDictBase</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_batched</span><span class="p">:</span>
            <span class="c1"># batched (aka &#39;vectorized&#39;) env reset is a bit special: envs are</span>
            <span class="c1"># automatically reset. What we do here is just to check if _reset</span>
            <span class="c1"># is present. If it is not, we just reset. Otherwise, we just skip.</span>
            <span class="k">if</span> <span class="n">tensordict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_reset</span><span class="p">(</span><span class="n">tensordict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">reset</span> <span class="o">=</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_reset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># we must copy the tensordict because the transform</span>
                <span class="c1"># expects a tuple (tensordict, tensordict_reset) where the</span>
                <span class="c1"># first still carries a _reset</span>
                <span class="n">tensordict</span> <span class="o">=</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">&quot;_reset&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reset</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_reset</span><span class="p">(</span><span class="n">tensordict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tensordict</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_reset</span><span class="p">(</span><span class="n">tensordict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="n">ACCEPTED_TYPE_ERRORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;render_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;__init__() got an unexpected keyword argument &#39;render_mode&#39;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;frame_skip&quot;</span><span class="p">:</span> <span class="s2">&quot;unexpected keyword argument &#39;frameskip&#39;&quot;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="GymEnv"><a class="viewcode-back" href="../../../../reference/generated/torchrl.envs.GymEnv.html#torchrl.envs.GymEnv">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">GymEnv</span><span class="p">(</span><span class="n">GymWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OpenAI Gym environment wrapper constructed by environment ID directly.</span>

<span class="sd">    Works accross `gymnasium &lt;https://gymnasium.farama.org/&gt;`_ and `OpenAI/gym &lt;https://github.com/openai/gym&gt;`_.</span>

<span class="sd">    Args:</span>
<span class="sd">        env_name (str): the environment id registered in `gym.registry`.</span>
<span class="sd">        categorical_action_encoding (bool, optional): if ``True``, categorical</span>
<span class="sd">            specs will be converted to the TorchRL equivalent (:class:`torchrl.data.Categorical`),</span>
<span class="sd">            otherwise a one-hot encoding will be used (:class:`torchrl.data.OneHot`).</span>
<span class="sd">            Defaults to ``False``.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        num_envs (int, optional): the number of envs to run in parallel. Defaults to</span>
<span class="sd">            ``None`` (a single env is to be run). :class:`~gym.vector.AsyncVectorEnv`</span>
<span class="sd">            will be used by default.</span>
<span class="sd">        disable_env_checker (bool, optional): for gym &gt; 0.24 only. If ``True`` (default</span>
<span class="sd">            for these versions), the environment checker won&#39;t be run.</span>
<span class="sd">        from_pixels (bool, optional): if ``True``, an attempt to return the pixel</span>
<span class="sd">            observations from the env will be performed. By default, these observations</span>
<span class="sd">            will be written under the ``&quot;pixels&quot;`` entry.</span>
<span class="sd">            The method being used varies</span>
<span class="sd">            depending on the gym version and may involve a ``wrappers.pixel_observation.PixelObservationWrapper``.</span>
<span class="sd">            Defaults to ``False``.</span>
<span class="sd">        pixels_only (bool, optional): if ``True``, only the pixel observations will</span>
<span class="sd">            be returned (by default under the ``&quot;pixels&quot;`` entry in the output tensordict).</span>
<span class="sd">            If ``False``, observations (eg, states) and pixels will be returned</span>
<span class="sd">            whenever ``from_pixels=True``. Defaults to ``False``.</span>
<span class="sd">        frame_skip (int, optional): if provided, indicates for how many steps the</span>
<span class="sd">            same action is to be repeated. The observation returned will be the</span>
<span class="sd">            last observation of the sequence, whereas the reward will be the sum</span>
<span class="sd">            of rewards across steps.</span>
<span class="sd">        device (torch.device, optional): if provided, the device on which the data</span>
<span class="sd">            is to be cast. Defaults to ``torch.device(&quot;cpu&quot;)``.</span>
<span class="sd">        batch_size (torch.Size, optional): the batch size of the environment.</span>
<span class="sd">            Should match the leading dimensions of all observations, done states,</span>
<span class="sd">            rewards, actions and infos.</span>
<span class="sd">            Defaults to ``torch.Size([])``.</span>
<span class="sd">        allow_done_after_reset (bool, optional): if ``True``, it is tolerated</span>
<span class="sd">            for envs to be ``done`` just after :meth:`reset` is called.</span>
<span class="sd">            Defaults to ``False``.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        available_envs (List[str]): the list of envs that can be built.</span>

<span class="sd">    .. note::</span>
<span class="sd">        If an attribute cannot be found, this class will attempt to retrieve it from</span>
<span class="sd">        the nested env:</span>

<span class="sd">            &gt;&gt;&gt; from torchrl.envs import GymEnv</span>
<span class="sd">            &gt;&gt;&gt; env = GymEnv(&quot;Pendulum-v1&quot;)</span>
<span class="sd">            &gt;&gt;&gt; print(env.spec.max_episode_steps)</span>
<span class="sd">            200</span>


<span class="sd">        If a use-case is not covered by TorchRL, please submit an issue on GitHub.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from torchrl.envs import GymEnv</span>
<span class="sd">        &gt;&gt;&gt; env = GymEnv(&quot;Pendulum-v1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; td = env.rand_step()</span>
<span class="sd">        &gt;&gt;&gt; print(td)</span>
<span class="sd">        TensorDict(</span>
<span class="sd">            fields={</span>
<span class="sd">                action: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.float32, is_shared=False),</span>
<span class="sd">                next: TensorDict(</span>
<span class="sd">                    fields={</span>
<span class="sd">                        done: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.bool, is_shared=False),</span>
<span class="sd">                        observation: Tensor(shape=torch.Size([3]), device=cpu, dtype=torch.float32, is_shared=False),</span>
<span class="sd">                        reward: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.float32, is_shared=False),</span>
<span class="sd">                        terminated: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.bool, is_shared=False),</span>
<span class="sd">                        truncated: Tensor(shape=torch.Size([1]), device=cpu, dtype=torch.bool, is_shared=False)},</span>
<span class="sd">                    batch_size=torch.Size([]),</span>
<span class="sd">                    device=cpu,</span>
<span class="sd">                    is_shared=False)},</span>
<span class="sd">            batch_size=torch.Size([]),</span>
<span class="sd">            device=cpu,</span>
<span class="sd">            is_shared=False)</span>
<span class="sd">        &gt;&gt;&gt; print(env.available_envs)</span>
<span class="sd">        [&#39;ALE/Adventure-ram-v5&#39;, &#39;ALE/Adventure-v5&#39;, &#39;ALE/AirRaid-ram-v5&#39;, &#39;ALE/AirRaid-v5&#39;, &#39;ALE/Alien-ram-v5&#39;, &#39;ALE/Alien-v5&#39;,</span>

<span class="sd">    .. note::</span>
<span class="sd">        If both `OpenAI/gym` and `gymnasium` are present in the virtual environment,</span>
<span class="sd">        one can swap backend using :func:`~torchrl.envs.libs.gym.set_gym_backend`:</span>

<span class="sd">            &gt;&gt;&gt; from torchrl.envs import set_gym_backend, GymEnv</span>
<span class="sd">            &gt;&gt;&gt; with set_gym_backend(&quot;gym&quot;):</span>
<span class="sd">            ...     env = GymEnv(&quot;Pendulum-v1&quot;)</span>
<span class="sd">            ...     print(env._env)</span>
<span class="sd">            &lt;class &#39;gym.wrappers.time_limit.TimeLimit&#39;&gt;</span>
<span class="sd">            &gt;&gt;&gt; with set_gym_backend(&quot;gymnasium&quot;):</span>
<span class="sd">            ...     env = GymEnv(&quot;Pendulum-v1&quot;)</span>
<span class="sd">            ...     print(env._env)</span>
<span class="sd">            &lt;class &#39;gymnasium.wrappers.time_limit.TimeLimit&#39;&gt;</span>

<span class="sd">    .. note::</span>
<span class="sd">        info dictionaries will be read using :class:`~torchrl.envs.gym_like.default_info_dict_reader`</span>
<span class="sd">        if no other reader is provided. To provide another reader, refer to</span>
<span class="sd">        :meth:`set_info_dict_reader`. To automatically register the info_dict</span>
<span class="sd">        content, refer to :meth:`torchrl.envs.GymLikeEnv.auto_register_info_dict`.</span>

<span class="sd">    .. note:: Gym spaces are not completely covered.</span>
<span class="sd">        The following spaces are accounted for provided that they can be represented by a torch.Tensor, a nested tensor</span>
<span class="sd">        and/or within a tensordict:</span>

<span class="sd">        - spaces.Box</span>
<span class="sd">        - spaces.Sequence</span>
<span class="sd">        - spaces.Tuple</span>
<span class="sd">        - spaces.Discrete</span>
<span class="sd">        - spaces.MultiBinary</span>
<span class="sd">        - spaces.MultiDiscrete</span>
<span class="sd">        - spaces.Dict</span>

<span class="sd">        Some considerations should be made when working with gym spaces. For instance, a tuple of spaces</span>
<span class="sd">        can only be supported if the spaces are semantically identical (same dtype and same number of dimensions).</span>
<span class="sd">        Ragged dimension can be supported through :func:`~torch.nested.nested_tensor`, but then there should be only</span>
<span class="sd">        one level of tuple and data should be stacked along the first dimension (as nested_tensors can only be</span>
<span class="sd">        stacked along the first dimension).</span>

<span class="sd">        Check the example in examples/envs/gym_conversion_examples.py to know more!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;env_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_gym_args</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.24.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_gym_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="n">disable_env_checker</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;disable_env_checker&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">disable_env_checker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;disable_env_checker should only be set if gym version is &gt; 0.24&quot;</span>
            <span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.24.0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_gym_args</span><span class="p">(</span>  <span class="c1"># noqa: F811</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;disable_env_checker&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_gym_args</span><span class="p">(</span>  <span class="c1"># noqa: F811</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">GYMNASIUM_1_ERROR</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_gym_args</span><span class="p">(</span>  <span class="c1"># noqa: F811</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;disable_env_checker&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_async_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gym_backend</span><span class="p">(</span><span class="s2">&quot;vector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">AsyncVectorEnv</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_env</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;gym.core.Env&quot;</span><span class="p">:</span>  <span class="c1"># noqa: F821</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_gym</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;gym not found, unable to create </span><span class="si">{</span><span class="n">env_name</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Consider downloading and installing gym from&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">git_url</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">from_pixels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;from_pixels&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_gym_default</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">from_pixels</span><span class="p">)</span>
        <span class="n">pixels_only</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pixels_only&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">num_envs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;num_envs&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">made_env</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;frameskip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_skip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper_frame_skip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">made_env</span><span class="p">:</span>
            <span class="c1"># env.__init__ may not be compatible with all the kwargs that</span>
            <span class="c1"># have been preset. We iterate through the various solutions</span>
            <span class="c1"># to find the config that works.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
                    <span class="c1"># we catch warnings as they may cause silent bugs</span>
                    <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;frameskip&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;unexpected keyword argument &#39;frameskip&#39;&quot;</span><span class="p">)</span>
                <span class="n">made_env</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ACCEPTED_TYPE_ERRORS</span><span class="p">[</span><span class="s2">&quot;frame_skip&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
                    <span class="c1"># we can disable this, not strictly indispensable to know</span>
                    <span class="c1"># warn(</span>
                    <span class="c1">#     &quot;Discarding frameskip arg. This will be taken care of by TorchRL env wrapper.&quot;</span>
                    <span class="c1"># )</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wrapper_frame_skip</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;frameskip&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ACCEPTED_TYPE_ERRORS</span><span class="p">[</span><span class="s2">&quot;render_mode&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
                    <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Discarding render_mode from the env constructor.&quot;</span><span class="p">)</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;render_mode&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
        <span class="n">env</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_build_env</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">pixels_only</span><span class="o">=</span><span class="n">pixels_only</span><span class="p">,</span> <span class="n">from_pixels</span><span class="o">=</span><span class="n">from_pixels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_envs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_env</span><span class="p">([</span><span class="n">CloudpickleWrapper</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">env</span><span class="p">)]</span> <span class="o">*</span> <span class="n">num_envs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="c1"># It would fail if the environment is not pickable. In that case,</span>
                <span class="c1"># delegating environment instantiation to each subprocess as a fallback.</span>
                <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_env</span><span class="p">(</span>
                    <span class="p">[</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span> <span class="o">*</span> <span class="n">num_envs</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">num_envs</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">env</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;0.25.1&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_gym_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">from_pixels</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="c1"># Do nothing for older gym versions.</span>
        <span class="k">pass</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gym&quot;</span><span class="p">,</span> <span class="s2">&quot;0.25.1&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_gym_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">from_pixels</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="k">if</span> <span class="n">from_pixels</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;render_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;rgb_array&quot;</span><span class="p">)</span>

    <span class="nd">@implement_for</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">,</span> <span class="s2">&quot;0.27.0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_gym_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">from_pixels</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
        <span class="k">if</span> <span class="n">from_pixels</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;render_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;rgb_array&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">env_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;env_name&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;env_name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected &#39;env_name&#39; to be part of kwargs&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(env=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env_name</span><span class="si">}</span><span class="s2">, batch_size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">, device=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="MOGymWrapper"><a class="viewcode-back" href="../../../../reference/generated/torchrl.envs.MOGymWrapper.html#torchrl.envs.MOGymWrapper">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">MOGymWrapper</span><span class="p">(</span><span class="n">GymWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FARAMA MO-Gymnasium environment wrapper.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mo_gymnasium as mo_gym</span>
<span class="sd">        &gt;&gt;&gt; env = MOGymWrapper(mo_gym.make(&#39;minecart-v0&#39;), frame_skip=4)</span>
<span class="sd">        &gt;&gt;&gt; td = env.rand_step()</span>
<span class="sd">        &gt;&gt;&gt; print(td)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">git_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/Farama-Foundation/MO-Gymnasium&quot;</span>
    <span class="n">libname</span> <span class="o">=</span> <span class="s2">&quot;mo-gymnasium&quot;</span>

    <span class="n">_make_specs</span> <span class="o">=</span> <span class="n">set_gym_backend</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">)(</span><span class="n">GymEnv</span><span class="o">.</span><span class="n">_make_specs</span><span class="p">)</span>

    <span class="nd">@_classproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">available_envs</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_mo</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;deep-sea-treasure-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deep-sea-treasure-concave-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resource-gathering-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fishwood-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;breakable-bottles-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fruit-tree-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;water-reservoir-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;four-room-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mo-mountaincar-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mo-mountaincarcontinuous-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mo-lunar-lander-v2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minecart-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mo-highway-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mo-highway-fast-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mo-supermario-v0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mo-reacher-v4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mo-hopper-v4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mo-halfcheetah-v4&quot;</span><span class="p">,</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="MOGymEnv"><a class="viewcode-back" href="../../../../reference/generated/torchrl.envs.MOGymEnv.html#torchrl.envs.MOGymEnv">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">MOGymEnv</span><span class="p">(</span><span class="n">GymEnv</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FARAMA MO-Gymnasium environment wrapper.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; env = MOGymEnv(env_name=&quot;minecart-v0&quot;, frame_skip=4)</span>
<span class="sd">        &gt;&gt;&gt; td = env.rand_step()</span>
<span class="sd">        &gt;&gt;&gt; print(td)</span>
<span class="sd">        &gt;&gt;&gt; print(env.available_envs)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">git_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/Farama-Foundation/MO-Gymnasium&quot;</span>
    <span class="n">libname</span> <span class="o">=</span> <span class="s2">&quot;mo-gymnasium&quot;</span>

    <span class="n">available_envs</span> <span class="o">=</span> <span class="n">MOGymWrapper</span><span class="o">.</span><span class="n">available_envs</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lib</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModuleType</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_has_mo</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">mo_gymnasium</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mo_gym</span>

            <span class="k">return</span> <span class="n">mo_gym</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">mo_gymnasium</span>  <span class="c1"># noqa: F401</span>
            <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;MO-gymnasium not found, check installation&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">_make_specs</span> <span class="o">=</span> <span class="n">set_gym_backend</span><span class="p">(</span><span class="s2">&quot;gymnasium&quot;</span><span class="p">)(</span><span class="n">GymEnv</span><span class="o">.</span><span class="n">_make_specs</span><span class="p">)</span></div>


<span class="k">class</span><span class="w"> </span><span class="nc">terminal_obs_reader</span><span class="p">(</span><span class="n">default_info_dict_reader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Terminal observation reader for &#39;vectorized&#39; gym environments.</span>

<span class="sd">    When running envs in parallel, Gym(nasium) writes the result of the true call</span>
<span class="sd">    to `step` in `&quot;final_observation&quot;` entry within the `info` dictionary.</span>

<span class="sd">    This breaks the natural flow and makes single-processed and multiprocessed envs</span>
<span class="sd">    incompatible.</span>

<span class="sd">    This class reads the info obs, removes the `&quot;final_observation&quot;` from</span>
<span class="sd">    the env and writes its content in the data.</span>

<span class="sd">    Next, a :class:`torchrl.envs.VecGymEnvTransform` transform will reorganise the</span>
<span class="sd">    data by caching the result of the (implicit) reset and swap the true next</span>
<span class="sd">    observation with the reset one. At reset time, the true reset data will be</span>
<span class="sd">    replaced.</span>

<span class="sd">    Args:</span>
<span class="sd">        observation_spec (Composite): The observation spec of the gym env.</span>
<span class="sd">        backend (str, optional): the backend of the env. One of `&quot;sb3&quot;` for</span>
<span class="sd">            stable-baselines3 or `&quot;gym&quot;` for gym/gymnasium.</span>

<span class="sd">    .. note:: In general, this class should not be handled directly. It is</span>
<span class="sd">        created whenever a vectorized environment is placed within a :class:`GymWrapper`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">backend_key</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sb3&quot;</span><span class="p">:</span> <span class="s2">&quot;terminal_observation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gym&quot;</span><span class="p">:</span> <span class="s2">&quot;final_observation&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">backend_info_key</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sb3&quot;</span><span class="p">:</span> <span class="s2">&quot;terminal_info&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gym&quot;</span><span class="p">:</span> <span class="s2">&quot;final_info&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_spec</span><span class="p">:</span> <span class="n">Composite</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;final&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obs_spec</span> <span class="o">=</span> <span class="n">observation_spec</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_validated</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">info_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_spec</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># Simplest case: there is one observation,</span>
            <span class="c1"># presented as a np.ndarray. The key should be pixels or observation.</span>
            <span class="c1"># We just write that value at its location in the tensor</span>
            <span class="n">tensor</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tensor</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="c1"># Simplest case: there is one observation,</span>
            <span class="c1"># presented as a np.ndarray. The key should be pixels or observation.</span>
            <span class="c1"># We just write that value at its location in the tensor</span>
            <span class="n">tensor</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">tensor</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The observation </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> could not be found in the final observation dict.&quot;</span>
                <span class="p">)</span>
            <span class="n">subobs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">subobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># if the obs is a dict, we expect that the key points also to</span>
                <span class="c1"># a value in the obs. We retrieve this value and write it in the</span>
                <span class="c1"># tensor</span>
                <span class="n">tensor</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">subobs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tensor</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="c1"># tuples are stacked along the first dimension when passing gym spaces</span>
            <span class="c1"># to torchrl specs. As such, we can simply stack the tuple and set it</span>
            <span class="c1"># at the relevant index (assuming stacking can be achieved)</span>
            <span class="n">tensor</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tensor</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Observations of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="si">}</span><span class="s2"> are not supported yet.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info_dict</span><span class="p">,</span> <span class="n">tensordict</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">replace_none</span><span class="p">(</span><span class="n">nparray</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nparray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nparray</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">nparray</span>
            <span class="n">is_none</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">nparray</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">is_none</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="c1"># Then it is a final observation and we delegate the registration to the appropriate reader</span>
                <span class="n">nz</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">is_none</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">zero_like</span> <span class="o">=</span> <span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">nparray</span><span class="p">[</span><span class="n">nz</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">is_none</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">nparray</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_like</span>
            <span class="k">return</span> <span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="o">*</span><span class="n">nparray</span><span class="p">)</span>

        <span class="n">info_dict</span> <span class="o">=</span> <span class="n">tree_map</span><span class="p">(</span><span class="n">replace_none</span><span class="p">,</span> <span class="n">info_dict</span><span class="p">)</span>
        <span class="c1"># convert info_dict to a tensordict</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="n">TensorDict</span><span class="p">(</span><span class="n">info_dict</span><span class="p">)</span>
        <span class="c1"># get the terminal observation</span>
        <span class="n">terminal_obs</span> <span class="o">=</span> <span class="n">info_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_key</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># get the terminal info dict</span>
        <span class="n">terminal_info</span> <span class="o">=</span> <span class="n">info_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_info_key</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">terminal_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">terminal_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">info_dict</span><span class="p">,</span> <span class="n">tensordict</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_final_validated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info_spec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info_spec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_final_validated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">final_info</span> <span class="o">=</span> <span class="n">terminal_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">terminal_obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_info</span><span class="p">[</span><span class="s2">&quot;observation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">terminal_obs</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_spec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_spec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span>

            <span class="n">final_obs_buffer</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>
            <span class="n">terminal_obs</span> <span class="o">=</span> <span class="n">final_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">terminal_obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">terminal_obs</span><span class="p">):</span>
                    <span class="c1"># writes final_obs inplace with terminal_obs content</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_read_obs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">final_obs_buffer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="n">tensordict</span><span class="o">.</span><span class="n">set</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">final_obs_buffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tensordict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_validated</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_flip_info_tuple</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
    <span class="c1"># In Gym &lt; 0.24, batched envs returned tuples of dict, and not dict of tuples.</span>
    <span class="c1"># We patch this by flipping the tuple -&gt; dict order.</span>
    <span class="n">info_example</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">info_example</span> <span class="o">=</span> <span class="n">info_example</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">info_example</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_info</span> <span class="ow">in</span> <span class="n">info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Meta.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>


        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
         <script src="../../../../_static/jquery.js"></script>
         <script src="../../../../_static/underscore.js"></script>
         <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../../_static/doctools.js"></script>
         <script src="../../../../_static/design-tabs.js"></script>
     

  

  <script type="text/javascript" src="../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
     
    <script type="text/javascript">
      $(document).ready(function() {
	  var downloadNote = $(".sphx-glr-download-link-note.admonition.note");
	  if (downloadNote.length >= 1) {
	      var tutorialUrl = $("#tutorial-type").text();
	      var githubLink = "https://github.com/pytorch/rl/blob/main/tutorials/sphinx-tutorials/"  + tutorialUrl + ".py",
		  notebookLink = $(".sphx-glr-download-jupyter").find(".download.reference")[0].href,
		  notebookDownloadPath = notebookLink.split('_downloads')[1],
		  colabLink = "https://colab.research.google.com/github/pytorch/rl/blob/gh-pages/main/_downloads" + notebookDownloadPath;

	      $(".pytorch-call-to-action-links a[data-response='Run in Google Colab']").attr("href", colabLink);
	      $(".pytorch-call-to-action-links a[data-response='View on Github']").attr("href", githubLink);
	  }

          var overwrite = function(_) {
              if ($(this).length > 0) {
                  $(this)[0].href = "https://github.com/pytorch/rl"
              }
          }
          // PC
          $(".main-menu a:contains('GitHub')").each(overwrite);
          // Mobile
          $(".main-menu a:contains('Github')").each(overwrite);
      });

      
       $(window).ready(function() {
           var original = window.sideMenus.bind;
           var startup = true;
           window.sideMenus.bind = function() {
               original();
               if (startup) {
                   $("#pytorch-right-menu a.reference.internal").each(function(i) {
                       if (this.classList.contains("not-expanded")) {
                           this.nextElementSibling.style.display = "block";
                           this.classList.remove("not-expanded");
                           this.classList.add("expanded");
                       }
                   });
                   startup = false;
               }
           };
       });
    </script>

    


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="https://www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="https://www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
           <li class="resources-mobile-menu-title">
             <a>Learn</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/get-started">Get Started</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials">Tutorials</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/basics/intro.html">Learn the Basics</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/recipes/recipes_index.html">PyTorch Recipes</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/introyt.html">Introduction to PyTorch - YouTube Series</a>
             </li>
           </ul>
           <li class="resources-mobile-menu-title">
             <a>Ecosystem</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/ecosystem">Tools</a>
             </li>
             <li>
               <a href="https://pytorch.org/#community-module">Community</a>
             </li>
             <li>
               <a href="https://discuss.pytorch.org/">Forums</a>
             </li>
             <li>
               <a href="https://pytorch.org/resources">Developer Resources</a>
             </li>
             <li>
               <a href="https://pytorch.org/ecosystem/contributor-awards-2023">Contributor Awards - 2024</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>Edge</a>
           </li>

           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/edge">About PyTorch Edge</a>
             </li>
             
             <li>
               <a href="https://pytorch.org/executorch-overview">ExecuTorch</a>
             </li>
             <li>
               <a href="https://pytorch.org/executorch/stable/index.html">ExecuTorch Documentation</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>Docs</a>
           </li>

           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/pytorch-domains">PyTorch Domains</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            <a>Blog & News</a>
          </li>
            
           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/blog/">PyTorch Blog</a>
            </li>
            <li>
              <a href="https://pytorch.org/community-blog">Community Blog</a>
            </li>

            <li>
              <a href="https://pytorch.org/videos">Videos</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>
            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>
            <li>
               <a href="https://pytorch.org/newsletter">Newsletter</a>
             </li>
          </ul>
          
          <li class="resources-mobile-menu-title">
            <a>About</a>
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>
            <li>
              <a href="https://pytorch.org/governing-board">Governing Board</a>
            </li>
            <li>
               <a href="https://pytorch.org/credits">Cloud Credit Program</a>
            </li>
            <li>
               <a href="https://pytorch.org/tac">Technical Advisory Council</a>
            </li>
            <li>
               <a href="https://pytorch.org/staff">Staff</a>
            </li>
            <li>
               <a href="https://pytorch.org/contact-us">Contact Us</a>
            </li>
          </ul>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>