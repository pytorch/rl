


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Service Registry &mdash; torchrl 0.11 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/pytorch.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sphinx-design.min.css" type="text/css" />
  <link rel="stylesheet" href="../https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="get_services" href="generated/torchrl.services.get_services.html" />
    <link rel="prev" title="DreamerValueLoss" href="generated/torchrl.objectives.DreamerValueLoss.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://shiftlab.github.io/pytorch/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://shiftlab.github.io/pytorch/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://shiftlab.github.io/pytorch/features">Features</a>
          </li>

          <li>
            <a href="https://shiftlab.github.io/pytorch/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://shiftlab.github.io/pytorch/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <a href="https://shiftlab.github.io/pytorch/resources">Resources</a>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   
  <div>

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href="../../versions.html"><span style="font-size:110%">0.11 &#x25BC</span></a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started-0.html">Get started with Environments, TED and transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started-1.html">Get started with TorchRL’s modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started-2.html">Getting started with model optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started-3.html">Get started with data collection and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started-4.html">Get started with logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started-5.html">Get started with your own first training loop</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/coding_ppo.html">Reinforcement Learning (PPO) with TorchRL Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/pendulum.html">Pendulum: Writing your environment and transforms with TorchRL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/torchrl_demo.html">Introduction to TorchRL</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/multiagent_ppo.html">Multi-Agent Reinforcement Learning (PPO) with TorchRL Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/torchrl_envs.html">TorchRL envs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/pretrained_models.html">Using pretrained models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dqn_with_rnn.html">Recurrent DQN: Training recurrent policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/rb_tutorial.html">Using Replay Buffers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/export.html">Exporting TorchRL modules</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/multiagent_competitive_ddpg.html">Competitive Multi-Agent Reinforcement Learning (DDPG) with TorchRL Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/multi_task.html">Task-specific policy in multi-task environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/coding_ddpg.html">TorchRL objectives: Coding a DDPG loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/coding_dqn.html">TorchRL trainer: A DQN example</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="knowledge_base.html">Knowledge Base</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">

      <section data-toggle="wy-nav-shift" class="pytorch-content-wrap">
        <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
          <div class="pytorch-breadcrumbs-wrapper">
            















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="index.html">API Reference</a> &gt;</li>
        
      <li>Service Registry</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="../_sources/reference/services.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
          </div>

          <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
            Shortcuts
          </div>
        </div>

        <div class="pytorch-content-left">
    
    
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" class="pytorch-article">
              
  <section id="service-registry">
<h1>Service Registry<a class="headerlink" href="#service-registry" title="Link to this heading">¶</a></h1>
<p id="ref-services">TorchRL provides a service registry system for managing distributed services across workers in distributed applications.
This is particularly useful for sharing resources like tokenizers, replay buffers, or Python executor pools across
multiple environments or collectors.</p>
<p>The service registry provides a <strong>backend-agnostic API</strong> for distributed service management. While the current
implementation focuses on Ray as the primary backend, the design allows for future backends (e.g., Monarch,
local multiprocessing) without changing the core API.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>The service registry provides a centralized way to register and access distributed services that can be shared across
different parts of your application. Services are registered once and can be accessed by any worker, with the underlying
backend handling the distributed communication and resource management.</p>
<p><strong>Current Backend Support:</strong></p>
<ul class="simple">
<li><p><strong>Ray</strong>: Full support for Ray-based distributed services (recommended for production use)</p></li>
<li><p><strong>Other backends</strong>: Planned for future releases (e.g., Monarch, local multiprocessing)</p></li>
</ul>
<section id="key-features">
<h3>Key Features<a class="headerlink" href="#key-features" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Centralized Management</strong>: Register services once and access them from anywhere in your distributed system</p></li>
<li><p><strong>Namespace Isolation</strong>: Services are isolated within namespaces for multi-tenant support</p></li>
<li><p><strong>Type Safety</strong>: Dict-like access with <code class="docutils literal notranslate"><span class="pre">services[&quot;name&quot;]</span></code> syntax</p></li>
<li><p><strong>Automatic Cleanup</strong>: Reset all services in a namespace with a single call</p></li>
<li><p><strong>Backend Flexibility</strong>: Designed to support multiple distributed backends (currently Ray)</p></li>
</ul>
</section>
</section>
<section id="basic-usage">
<h2>Basic Usage<a class="headerlink" href="#basic-usage" title="Link to this heading">¶</a></h2>
<section id="getting-started">
<h3>Getting Started<a class="headerlink" href="#getting-started" title="Link to this heading">¶</a></h3>
<p>The service registry API is backend-agnostic, but you need to specify which backend to use when getting the registry.
Currently, Ray is the only supported backend.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">torchrl.services</span> <span class="kn">import</span> <span class="n">get_services</span>

<span class="c1"># Initialize your backend (Ray in this example)</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="c1"># Get the service registry for your chosen backend</span>
<span class="n">services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;my_namespace&quot;</span><span class="p">)</span>

<span class="c1"># Register a service (the class will become a distributed service)</span>
<span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span>
    <span class="n">TokenizerService</span><span class="p">,</span>
    <span class="n">vocab_size</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
    <span class="n">num_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Backend-specific option (Ray)</span>
<span class="p">)</span>

<span class="c1"># Access the service from any worker</span>
<span class="c1"># (other workers just need to call get_services with the same backend and namespace)</span>
<span class="n">services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;my_namespace&quot;</span><span class="p">)</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">]</span>

<span class="c1"># Call the service (syntax depends on backend)</span>
<span class="c1"># For Ray, you need to use .remote() and ray.get()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&quot;Hello world&quot;</span><span class="p">))</span>

<span class="c1"># Cleanup when done</span>
<span class="n">services</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="service-registration">
<h3>Service Registration<a class="headerlink" href="#service-registration" title="Link to this heading">¶</a></h3>
<p>Services are registered by providing a name, a class (that will become a distributed service), and any initialization arguments.
The exact behavior depends on the backend being used.</p>
<p><strong>Basic Registration (Backend-Agnostic):</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Register a service with constructor arguments</span>
<span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s2">&quot;my_service&quot;</span><span class="p">,</span>
    <span class="n">MyServiceClass</span><span class="p">,</span>
    <span class="n">arg1</span><span class="o">=</span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
    <span class="n">arg2</span><span class="o">=</span><span class="s2">&quot;value2&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">register</span></code> method accepts:</p>
<ul class="simple">
<li><p><strong>name</strong> (str): Unique identifier for the service</p></li>
<li><p><strong>service_factory</strong> (type): Class to instantiate as a distributed service</p></li>
<li><p><strong>kwargs</strong>: Arguments passed to the service constructor and/or backend-specific options</p></li>
</ul>
<p><strong>Backend-Specific Options (Ray):</strong></p>
<p>When using the Ray backend, you can pass Ray actor options alongside constructor arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ray-specific: Mix actor options and constructor arguments</span>
<span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s2">&quot;gpu_service&quot;</span><span class="p">,</span>
    <span class="n">GPUService</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;gpt2&quot;</span><span class="p">,</span>      <span class="c1"># Constructor argument</span>
    <span class="n">num_cpus</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>             <span class="c1"># Ray actor option</span>
    <span class="n">num_gpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>             <span class="c1"># Ray actor option</span>
    <span class="n">max_concurrency</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>     <span class="c1"># Ray actor option</span>
<span class="p">)</span>
</pre></div>
</div>
<p>For more explicit separation of backend options and constructor arguments, the Ray backend provides
<code class="docutils literal notranslate"><span class="pre">register_with_options</span></code> (note that options are expected not to collide with constructor arguments):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ray-specific: Explicit separation of options</span>
<span class="n">services</span><span class="o">.</span><span class="n">register_with_options</span><span class="p">(</span>
    <span class="s2">&quot;my_service&quot;</span><span class="p">,</span>
    <span class="n">MyServiceClass</span><span class="p">,</span>
    <span class="n">actor_options</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;num_cpus&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;num_gpus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;max_concurrency&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;gpt2&quot;</span><span class="p">,</span>  <span class="c1"># Constructor argument</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>      <span class="c1"># Constructor argument</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">register_with_options</span></code> method is specific to the Ray backend. Other backends may have
different mechanisms for separating backend options from constructor arguments.</p>
</div>
</section>
<section id="service-access">
<h3>Service Access<a class="headerlink" href="#service-access" title="Link to this heading">¶</a></h3>
<p>Services can be accessed using dict-like syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check if service exists</span>
<span class="k">if</span> <span class="s2">&quot;tokenizer&quot;</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">]</span>

<span class="c1"># Get service (raises KeyError if not found)</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">]</span>

<span class="c1"># Alternative: use get() method</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">)</span>

<span class="c1"># List all services</span>
<span class="n">service_names</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available services: </span><span class="si">{</span><span class="n">service_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="cross-worker-visibility">
<h3>Cross-Worker Visibility<a class="headerlink" href="#cross-worker-visibility" title="Link to this heading">¶</a></h3>
<p>Services registered by one worker are immediately visible to all other workers in the same namespace.
This is a core feature of the service registry, enabled by the underlying distributed backend.</p>
<p><strong>Example with Ray Backend:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">torchrl.services</span> <span class="kn">import</span> <span class="n">get_services</span>

<span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">class</span> <span class="nc">Worker</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">register_service</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Worker 1: Register a service</span>
        <span class="n">services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;shared&quot;</span><span class="p">)</span>
        <span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;shared_tokenizer&quot;</span><span class="p">,</span> <span class="n">TokenizerService</span><span class="p">,</span> <span class="n">vocab_size</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;registered&quot;</span>

    <span class="k">def</span> <span class="nf">use_service</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Worker 2: Use the service registered by Worker 1</span>
        <span class="n">services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;shared&quot;</span><span class="p">)</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="s2">&quot;shared_tokenizer&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">))</span>

<span class="c1"># Worker 1 registers the service</span>
<span class="n">worker1</span> <span class="o">=</span> <span class="n">Worker</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker1</span><span class="o">.</span><span class="n">register_service</span><span class="o">.</span><span class="n">remote</span><span class="p">())</span>

<span class="c1"># Worker 2 can immediately use it</span>
<span class="n">worker2</span> <span class="o">=</span> <span class="n">Worker</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker2</span><span class="o">.</span><span class="n">use_service</span><span class="o">.</span><span class="n">remote</span><span class="p">())</span>
</pre></div>
</div>
<p>The key insight is that both workers access the same service registry by using the same <code class="docutils literal notranslate"><span class="pre">backend</span></code> and
<code class="docutils literal notranslate"><span class="pre">namespace</span></code> parameters in <code class="docutils literal notranslate"><span class="pre">get_services()</span></code>. The backend handles the distributed coordination.</p>
</section>
<section id="namespace-isolation">
<h3>Namespace Isolation<a class="headerlink" href="#namespace-isolation" title="Link to this heading">¶</a></h3>
<p>Different namespaces provide complete isolation between service registries:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Training namespace</span>
<span class="n">train_services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">)</span>
<span class="n">train_services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="n">TokenizerService</span><span class="p">,</span> <span class="n">vocab_size</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>

<span class="c1"># Evaluation namespace</span>
<span class="n">eval_services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;evaluation&quot;</span><span class="p">)</span>
<span class="n">eval_services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="n">TokenizerService</span><span class="p">,</span> <span class="n">vocab_size</span><span class="o">=</span><span class="mi">30000</span><span class="p">)</span>

<span class="c1"># These are completely independent services</span>
<span class="k">assert</span> <span class="s2">&quot;tokenizer&quot;</span> <span class="ow">in</span> <span class="n">train_services</span>
<span class="k">assert</span> <span class="s2">&quot;tokenizer&quot;</span> <span class="ow">in</span> <span class="n">eval_services</span>
<span class="c1"># But they have different configurations</span>
</pre></div>
</div>
</section>
<section id="cleanup">
<h3>Cleanup<a class="headerlink" href="#cleanup" title="Link to this heading">¶</a></h3>
<p>Always clean up services when done to free resources:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reset all services in a namespace</span>
<span class="n">services</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="c1"># This terminates all service actors and clears the registry</span>
<span class="c1"># After reset(), the registry is empty</span>
<span class="k">assert</span> <span class="n">services</span><span class="o">.</span><span class="n">list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[]</span>
</pre></div>
</div>
</section>
</section>
<section id="python-executor-service">
<h2>Python Executor Service<a class="headerlink" href="#python-executor-service" title="Link to this heading">¶</a></h2>
<p>One of the most useful built-in services is the <a class="reference internal" href="generated/torchrl.envs.llm.transforms.PythonExecutorService.html#torchrl.envs.llm.transforms.PythonExecutorService" title="torchrl.envs.llm.transforms.PythonExecutorService"><code class="xref py py-class docutils literal notranslate"><span class="pre">PythonExecutorService</span></code></a>,
which provides a shared pool of Python interpreter processes for executing code across multiple environments.
This service is designed to work with any backend, though it’s currently optimized for Ray.</p>
<section id="id1">
<h3>Overview<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>The Python Executor Service allows you to share a fixed pool of Python interpreters (e.g., 32 processes) across
many environments (e.g., 128 environments). This provides significant resource savings compared to giving each
environment its own interpreter process. The service is registered through the service registry and can be
accessed by any worker using the <a class="reference internal" href="generated/torchrl.envs.llm.transforms.PythonInterpreter.html#torchrl.envs.llm.transforms.PythonInterpreter" title="torchrl.envs.llm.transforms.PythonInterpreter"><code class="xref py py-class docutils literal notranslate"><span class="pre">PythonInterpreter</span></code></a> transform.</p>
<p><strong>Resource Efficiency:</strong></p>
<table class="docutils # Necessary for the table generated by autosummary to look decent align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Configuration</p></th>
<th class="head"><p>Environments</p></th>
<th class="head"><p>Processes</p></th>
<th class="head"><p>Resource Usage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Local (persistent)</p></td>
<td><p>128</p></td>
<td><p>128</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-odd"><td><p>Service (pool=32)</p></td>
<td><p>128</p></td>
<td><p>32</p></td>
<td><p><strong>25%</strong></p></td>
</tr>
<tr class="row-even"><td><p>Service (pool=64)</p></td>
<td><p>128</p></td>
<td><p>64</p></td>
<td><p><strong>50%</strong></p></td>
</tr>
</tbody>
</table>
</section>
<section id="id2">
<h3>Basic Usage<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>The Python Executor Service is registered like any other service, then accessed through the
<a class="reference internal" href="generated/torchrl.envs.llm.transforms.PythonInterpreter.html#torchrl.envs.llm.transforms.PythonInterpreter" title="torchrl.envs.llm.transforms.PythonInterpreter"><code class="xref py py-class docutils literal notranslate"><span class="pre">PythonInterpreter</span></code></a> transform by specifying <code class="docutils literal notranslate"><span class="pre">services=&quot;ray&quot;</span></code>
(or the appropriate backend name).</p>
<p><strong>Example with Ray Backend:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">torchrl.services</span> <span class="kn">import</span> <span class="n">get_services</span>
<span class="kn">from</span> <span class="nn">torchrl.envs.llm.transforms</span> <span class="kn">import</span> <span class="n">PythonExecutorService</span><span class="p">,</span> <span class="n">PythonInterpreter</span>
<span class="kn">from</span> <span class="nn">torchrl.envs.llm</span> <span class="kn">import</span> <span class="n">ChatEnv</span>

<span class="c1"># Initialize your backend</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="c1"># Register the Python executor service</span>
<span class="n">services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;my_namespace&quot;</span><span class="p">)</span>
<span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s2">&quot;python_executor&quot;</span><span class="p">,</span>
    <span class="n">PythonExecutorService</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>           <span class="c1"># 32 interpreter processes</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>           <span class="c1"># 10 second timeout</span>
    <span class="n">num_cpus</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>            <span class="c1"># Ray-specific: Allocate 32 CPUs</span>
    <span class="n">max_concurrency</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>     <span class="c1"># Ray-specific: Allow 32 concurrent executions</span>
<span class="p">)</span>

<span class="c1"># Create environments that use the service</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">ChatEnv</span><span class="p">(</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,),</span>  <span class="c1"># 128 parallel environments</span>
    <span class="n">system_prompt</span><span class="o">=</span><span class="s2">&quot;Execute Python code when requested.&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Add PythonInterpreter transform configured to use the service</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">append_transform</span><span class="p">(</span>
    <span class="n">PythonInterpreter</span><span class="p">(</span>
        <span class="n">services</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span>              <span class="c1"># Use Ray backend</span>
        <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;my_namespace&quot;</span><span class="p">,</span>    <span class="c1"># Same namespace as registration</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># All 128 environments now share the 32 interpreters!</span>
<span class="c1"># The backend (Ray) automatically queues requests when all interpreters are busy</span>
</pre></div>
</div>
</section>
<section id="optional-service-usage">
<h3>Optional Service Usage<a class="headerlink" href="#optional-service-usage" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="generated/torchrl.envs.llm.transforms.PythonInterpreter.html#torchrl.envs.llm.transforms.PythonInterpreter" title="torchrl.envs.llm.transforms.PythonInterpreter"><code class="xref py py-class docutils literal notranslate"><span class="pre">PythonInterpreter</span></code></a> transform supports optional service usage.
You can easily switch between using a shared service or local processes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Option 1: Use shared Ray service (recommended for many envs)</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">append_transform</span><span class="p">(</span>
    <span class="n">PythonInterpreter</span><span class="p">(</span>
        <span class="n">services</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;my_namespace&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Option 2: Use local persistent processes (good for few envs)</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">append_transform</span><span class="p">(</span>
    <span class="n">PythonInterpreter</span><span class="p">(</span>
        <span class="n">services</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Option 3: Use temporary processes (good for infrequent use)</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">append_transform</span><span class="p">(</span>
    <span class="n">PythonInterpreter</span><span class="p">(</span>
        <span class="n">services</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="conditional-usage-pattern">
<h3>Conditional Usage Pattern<a class="headerlink" href="#conditional-usage-pattern" title="Link to this heading">¶</a></h3>
<p>You can decide at runtime whether to use a distributed service based on your configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">torchrl.services</span> <span class="kn">import</span> <span class="n">get_services</span>
<span class="kn">from</span> <span class="nn">torchrl.envs.llm.transforms</span> <span class="kn">import</span> <span class="n">PythonExecutorService</span><span class="p">,</span> <span class="n">PythonInterpreter</span>

<span class="n">num_envs</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">use_distributed_service</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="n">num_envs</span> <span class="o">&gt;</span> <span class="mi">16</span>

<span class="k">if</span> <span class="n">use_distributed_service</span><span class="p">:</span>
    <span class="c1"># Use distributed service for efficient resource usage</span>
    <span class="n">services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">)</span>  <span class="c1"># Could be other backends in the future</span>
    <span class="k">if</span> <span class="s2">&quot;python_executor&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
        <span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="s2">&quot;python_executor&quot;</span><span class="p">,</span>
            <span class="n">PythonExecutorService</span><span class="p">,</span>
            <span class="n">pool_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
            <span class="n">num_cpus</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>            <span class="c1"># Backend-specific option</span>
            <span class="n">max_concurrency</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>     <span class="c1"># Backend-specific option</span>
        <span class="p">)</span>

    <span class="c1"># Configure transform to use the service</span>
    <span class="n">interpreter</span> <span class="o">=</span> <span class="n">PythonInterpreter</span><span class="p">(</span><span class="n">services</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Use local processes (no distributed backend)</span>
    <span class="n">interpreter</span> <span class="o">=</span> <span class="n">PythonInterpreter</span><span class="p">(</span><span class="n">services</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">append_transform</span><span class="p">(</span><span class="n">interpreter</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="how-it-works">
<h3>How It Works<a class="headerlink" href="#how-it-works" title="Link to this heading">¶</a></h3>
<p>The Python Executor Service uses a simple round-robin assignment strategy to distribute work across
a pool of interpreter processes. The backend handles concurrency control and request queuing.</p>
<p><strong>Architecture:</strong></p>
<ol class="arabic simple">
<li><p><strong>Pool of Interpreters</strong>: The service maintains a fixed pool of <code class="docutils literal notranslate"><span class="pre">PersistentPythonProcess</span></code> instances</p></li>
<li><p><strong>Round-Robin Assignment</strong>: Each request is assigned to the next interpreter in the pool</p></li>
<li><p><strong>Backend Queuing</strong>: When all interpreters are busy, the backend queues additional requests</p></li>
<li><p><strong>Concurrent Execution</strong>: The backend controls how many requests can execute simultaneously</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inside PythonExecutorService</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="c1"># Simple round-robin assignment</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span>

    <span class="c1"># Backend handles queuing (e.g., Ray&#39;s max_concurrency parameter)</span>
    <span class="k">return</span> <span class="n">process</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Backend-Specific Behavior:</strong></p>
<ul class="simple">
<li><p><strong>Ray</strong>: Uses the <code class="docutils literal notranslate"><span class="pre">max_concurrency</span></code> parameter to control concurrent executions. Requests beyond
this limit are automatically queued by Ray’s actor system.</p></li>
<li><p><strong>Other backends</strong>: Will have their own mechanisms for concurrency control and queuing.</p></li>
</ul>
</section>
<section id="performance-considerations">
<h3>Performance Considerations<a class="headerlink" href="#performance-considerations" title="Link to this heading">¶</a></h3>
<p><strong>When to Use Service Mode (Distributed):</strong></p>
<ul class="simple">
<li><p>Running &gt; 16 parallel environments</p></li>
<li><p>Resource efficiency is important</p></li>
<li><p>Code execution is frequent</p></li>
<li><p>Have a distributed backend available (e.g., Ray)</p></li>
</ul>
<p><strong>When to Use Local Persistent Mode:</strong></p>
<ul class="simple">
<li><p>Running &lt; 16 environments</p></li>
<li><p>Need strict isolation between environments</p></li>
<li><p>Latency is critical</p></li>
<li><p>Don’t want distributed backend dependency</p></li>
</ul>
<p><strong>When to Use Local Temp File Mode:</strong></p>
<ul class="simple">
<li><p>Code execution is infrequent</p></li>
<li><p>Don’t want persistent processes</p></li>
<li><p>Memory is more important than speed</p></li>
</ul>
</section>
</section>
<section id="advanced-usage">
<h2>Advanced Usage<a class="headerlink" href="#advanced-usage" title="Link to this heading">¶</a></h2>
<section id="multiple-service-configurations">
<h3>Multiple Service Configurations<a class="headerlink" href="#multiple-service-configurations" title="Link to this heading">¶</a></h3>
<p>You can register multiple services with different configurations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">)</span>

<span class="c1"># Fast service for simple code</span>
<span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s2">&quot;python_executor_fast&quot;</span><span class="p">,</span>
    <span class="n">PythonExecutorService</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
    <span class="n">num_cpus</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">max_concurrency</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Heavy service for complex code</span>
<span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s2">&quot;python_executor_heavy&quot;</span><span class="p">,</span>
    <span class="n">PythonExecutorService</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
    <span class="n">num_cpus</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">max_concurrency</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Use different services for different environments</span>
<span class="n">fast_env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">append_transform</span><span class="p">(</span>
    <span class="n">PythonInterpreter</span><span class="p">(</span><span class="n">services</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;python_executor_fast&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">heavy_env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">append_transform</span><span class="p">(</span>
    <span class="n">PythonInterpreter</span><span class="p">(</span><span class="n">services</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;python_executor_heavy&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="custom-services">
<h3>Custom Services<a class="headerlink" href="#custom-services" title="Link to this heading">¶</a></h3>
<p>You can create your own services by defining a class and registering it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyCustomService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A custom service for your application.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1"># Initialize your service</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># Process data and return results</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Processed: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

<span class="c1"># Register the custom service</span>
<span class="n">services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">)</span>
<span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s2">&quot;my_service&quot;</span><span class="p">,</span>
    <span class="n">MyCustomService</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;param1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">},</span>
    <span class="n">num_cpus</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Use the service</span>
<span class="n">my_service</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="s2">&quot;my_service&quot;</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">my_service</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
<section id="api-reference">
<h2>API Reference<a class="headerlink" href="#api-reference" title="Link to this heading">¶</a></h2>
<section id="id3">
<h3>Service Registry<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<table class="autosummary longtable docutils # Necessary for the table generated by autosummary to look decent align-default">
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="generated/torchrl.services.get_services.html#torchrl.services.get_services" title="torchrl.services.get_services"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get_services</span></code></a>([backend])</p></td>
<td><p>Get a distributed service registry.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="generated/torchrl.services.ServiceBase.html#torchrl.services.ServiceBase" title="torchrl.services.ServiceBase"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ServiceBase</span></code></a>()</p></td>
<td><p>Base class for distributed service registries.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="generated/torchrl.services.RayService.html#torchrl.services.RayService" title="torchrl.services.RayService"><code class="xref py py-obj docutils literal notranslate"><span class="pre">RayService</span></code></a>([ray_init_config, namespace])</p></td>
<td><p>Ray-based distributed service registry.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id4">
<h3>Python Executor Service<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<table class="autosummary longtable docutils # Necessary for the table generated by autosummary to look decent align-default">
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="generated/torchrl.envs.llm.transforms.PythonExecutorService.html#torchrl.envs.llm.transforms.PythonExecutorService" title="torchrl.envs.llm.transforms.PythonExecutorService"><code class="xref py py-obj docutils literal notranslate"><span class="pre">PythonExecutorService</span></code></a>([pool_size, timeout])</p></td>
<td><p>Ray actor that manages a pool of persistent Python interpreters.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="generated/torchrl.envs.llm.transforms.PythonInterpreter.html#torchrl.envs.llm.transforms.PythonInterpreter" title="torchrl.envs.llm.transforms.PythonInterpreter"><code class="xref py py-obj docutils literal notranslate"><span class="pre">PythonInterpreter</span></code></a>([tokenizer, tool_name, ...])</p></td>
<td><p>A transform that executes Python code in the LLM response.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">¶</a></h2>
<ol class="arabic">
<li><p><strong>Specify Backend and Namespace</strong>: Always explicitly specify both the backend and namespace when calling
<code class="docutils literal notranslate"><span class="pre">get_services()</span></code> to ensure services are registered and accessed from the correct location.</p></li>
<li><p><strong>Clean Up</strong>: Always call <code class="docutils literal notranslate"><span class="pre">services.reset()</span></code> when done to free resources and terminate distributed services.</p></li>
<li><p><strong>Service Naming</strong>: Use descriptive names that indicate the service’s purpose (e.g., <code class="docutils literal notranslate"><span class="pre">&quot;python_executor&quot;</span></code>,
<code class="docutils literal notranslate"><span class="pre">&quot;tokenizer_service&quot;</span></code>).</p></li>
<li><p><strong>Backend-Specific Options</strong>: Understand which options are backend-specific (e.g., <code class="docutils literal notranslate"><span class="pre">num_cpus</span></code>, <code class="docutils literal notranslate"><span class="pre">num_gpus</span></code>,
<code class="docutils literal notranslate"><span class="pre">max_concurrency</span></code> for Ray) and which are constructor arguments for your service class.</p></li>
<li><p><strong>Error Handling</strong>: Check if services exist before accessing them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;my_service&quot;</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="s2">&quot;my_service&quot;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Register or handle missing service</span>
</pre></div>
</div>
</li>
<li><p><strong>Conditional Registration</strong>: Only register services if they don’t already exist:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;python_executor&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
    <span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;python_executor&quot;</span><span class="p">,</span> <span class="n">PythonExecutorService</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Context Managers</strong>: Consider using context managers for automatic cleanup:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ServiceContext</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="n">get_services</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="k">with</span> <span class="n">ServiceContext</span><span class="p">(</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="s2">&quot;my_namespace&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">services</span><span class="p">:</span>
    <span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;my_service&quot;</span><span class="p">,</span> <span class="n">MyService</span><span class="p">)</span>
    <span class="c1"># Use services...</span>
<span class="c1"># Automatic cleanup</span>
</pre></div>
</div>
</li>
<li><p><strong>Backend Portability</strong>: When writing code that should work with multiple backends, avoid using
backend-specific methods like <code class="docutils literal notranslate"><span class="pre">register_with_options()</span></code> (Ray-only). Stick to the common <code class="docutils literal notranslate"><span class="pre">register()</span></code>
API for maximum portability.</p></li>
</ol>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Link to this heading">¶</a></h2>
<p>For complete examples, see:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">examples/services/distributed_services.py</span></code> - Basic service registry usage</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">examples/llm/python_executor_service.py</span></code> - Python executor service examples</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test/test_services.py</span></code> - Comprehensive test suite</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test/test_python_executor_service.py</span></code> - Python executor service tests</p></li>
</ul>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="llms.html"><span class="doc">LLM Interface</span></a> - LLM API documentation</p></li>
<li><p><a class="reference internal" href="collectors_basics.html#ref-collectors"><span class="std std-ref">Collector Basics</span></a> - Collector documentation</p></li>
<li><p><a class="reference external" href="https://docs.ray.io/">Ray Documentation</a> - Ray distributed framework documentation</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Future Backend Support</strong></p>
<p>The service registry is designed to be backend-agnostic. While Ray is currently the only supported
backend, the API is structured to easily accommodate additional backends in the future, such as:</p>
<ul class="simple">
<li><p><strong>Monarch</strong>: For specialized distributed computing scenarios</p></li>
<li><p><strong>Local Multiprocessing</strong>: For single-node parallelism without external dependencies</p></li>
<li><p><strong>Custom Backends</strong>: You can implement your own backend by subclassing <a class="reference internal" href="generated/torchrl.services.ServiceBase.html#torchrl.services.ServiceBase" title="torchrl.services.ServiceBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">ServiceBase</span></code></a></p></li>
</ul>
<p>The core API (<code class="docutils literal notranslate"><span class="pre">get_services()</span></code>, <code class="docutils literal notranslate"><span class="pre">register()</span></code>, <code class="docutils literal notranslate"><span class="pre">get()</span></code>, <code class="docutils literal notranslate"><span class="pre">list()</span></code>, <code class="docutils literal notranslate"><span class="pre">reset()</span></code>) will remain
consistent across all backends, ensuring your code remains portable.</p>
</div>
</section>
</section>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="generated/torchrl.services.get_services.html" class="btn btn-neutral float-right" title="get_services" accesskey="n" rel="next">Next <img src="../_static/images/chevron-right-orange.svg" class="next-page"></a>
      
      
        <a href="generated/torchrl.objectives.DreamerValueLoss.html" class="btn btn-neutral" title="DreamerValueLoss" accesskey="p" rel="prev"><img src="../_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Meta.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

          </div>


        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Service Registry</a><ul>
<li><a class="reference internal" href="#overview">Overview</a><ul>
<li><a class="reference internal" href="#key-features">Key Features</a></li>
</ul>
</li>
<li><a class="reference internal" href="#basic-usage">Basic Usage</a><ul>
<li><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li><a class="reference internal" href="#service-registration">Service Registration</a></li>
<li><a class="reference internal" href="#service-access">Service Access</a></li>
<li><a class="reference internal" href="#cross-worker-visibility">Cross-Worker Visibility</a></li>
<li><a class="reference internal" href="#namespace-isolation">Namespace Isolation</a></li>
<li><a class="reference internal" href="#cleanup">Cleanup</a></li>
</ul>
</li>
<li><a class="reference internal" href="#python-executor-service">Python Executor Service</a><ul>
<li><a class="reference internal" href="#id1">Overview</a></li>
<li><a class="reference internal" href="#id2">Basic Usage</a></li>
<li><a class="reference internal" href="#optional-service-usage">Optional Service Usage</a></li>
<li><a class="reference internal" href="#conditional-usage-pattern">Conditional Usage Pattern</a></li>
<li><a class="reference internal" href="#how-it-works">How It Works</a></li>
<li><a class="reference internal" href="#performance-considerations">Performance Considerations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-usage">Advanced Usage</a><ul>
<li><a class="reference internal" href="#multiple-service-configurations">Multiple Service Configurations</a></li>
<li><a class="reference internal" href="#custom-services">Custom Services</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-reference">API Reference</a><ul>
<li><a class="reference internal" href="#id3">Service Registry</a></li>
<li><a class="reference internal" href="#id4">Python Executor Service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#best-practices">Best Practices</a></li>
<li><a class="reference internal" href="#examples">Examples</a></li>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.11',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
      <script type="text/javascript" src="../_static/design-tabs.js"></script>

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
     
    <script type="text/javascript">
      $(document).ready(function() {
	  var downloadNote = $(".sphx-glr-download-link-note.admonition.note");
	  if (downloadNote.length >= 1) {
	      var tutorialUrl = $("#tutorial-type").text();
	      var githubLink = "https://github.com/pytorch/rl/blob/main/tutorials/sphinx-"  + tutorialUrl + ".py",
		  notebookLink = $(".sphx-glr-download-jupyter").find(".download.reference")[0].href,
		  notebookDownloadPath = notebookLink.split('_downloads')[1],
		  colabLink = "https://colab.research.google.com/github/pytorch/rl/blob/gh-pages/main/_downloads" + notebookDownloadPath;

	      $(".pytorch-call-to-action-links a[data-response='Run in Google Colab']").attr("href", colabLink);
	      $(".pytorch-call-to-action-links a[data-response='View on Github']").attr("href", githubLink);
	  }

          var overwrite = function(_) {
              if ($(this).length > 0) {
                  $(this)[0].href = "https://github.com/pytorch/rl"
              }
          }
          // PC
          $(".main-menu a:contains('GitHub')").each(overwrite);
          // Mobile
          $(".main-menu a:contains('Github')").each(overwrite);
      });

      
       $(window).ready(function() {
           var original = window.sideMenus.bind;
           var startup = true;
           window.sideMenus.bind = function() {
               original();
               if (startup) {
                   $("#pytorch-right-menu a.reference.internal").each(function(i) {
                       if (this.classList.contains("not-expanded")) {
                           this.nextElementSibling.style.display = "block";
                           this.classList.remove("not-expanded");
                           this.classList.add("expanded");
                       }
                   });
                   startup = false;
               }
           };
       });
    </script>

    


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Lorem ipsum dolor sit amet, consectetur</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Lorem ipsum dolor sit amet, consectetur</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Lorem ipsum dolor sit amet, consectetur</p>
          <a class="with-right-arrow" href="https://shiftlab.github.io/pytorch/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://shiftlab.github.io/pytorch/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://shiftlab.github.io/pytorch/">PyTorch</a></li>
            <li><a href="https://shiftlab.github.io/pytorch/get-started">Get Started</a></li>
            <li><a href="https://shiftlab.github.io/pytorch/features">Features</a></li>
            <li><a href="https://shiftlab.github.io/pytorch/ecosystem">Ecosystem</a></li>
            <li><a href="https://shiftlab.github.io/pytorch/blog/">Blog</a></li>
            <li><a href="https://shiftlab.github.io/pytorch/resources">Resources</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://shiftlab.github.io/pytorch/support">Support</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.slack.com" target="_blank">Slack</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md" target="_blank">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Follow Us</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://shiftlab.github.io/pytorch/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="#">Get Started</a>
          </li>

          <li>
            <a href="#">Features</a>
          </li>

          <li>
            <a href="#">Ecosystem</a>
          </li>

          <li>
            <a href="https://shiftlab.github.io/pytorch/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <a href="https://shiftlab.github.io/pytorch/resources">Resources</a>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    mobileMenu.bind();
    mobileTOC.bind();
    pytorchAnchors.bind();

    $(window).on("load", function() {
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
    })

    // Add class to links that have code blocks, since we cannot create links in code blocks
    $("article.pytorch-article a span.pre").each(function(e) {
      $(this).closest("a").addClass("has-code");
    });
  </script>
</body>
</html>